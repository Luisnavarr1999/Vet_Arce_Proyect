{% extends "./master.html" %}
{% block title %}
  Dashboard
{% endblock title %}
{% block content %}
  <section class="dashboard-hero card border-0 shadow-sm mb-4">
    <div class="card-body">
      <h2 class="fw-semibold mb-2">Indicadores operativos</h2>
      <p class="mb-0 text-muted">
        Vista basada en {{ alcance_global|yesno:"toda la veterinaria,sus citas asignadas" }}.
      </p>
    </div>
  </section>

  <form method="get" class="row g-3 align-items-end mb-4">
    <div class="col-sm-6 col-md-3">
      <label class="form-label small text-uppercase text-muted">Año</label>
      <select name="year" class="form-select">
        {% for year in year_options %}
          <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-6 col-md-3">
      <label class="form-label small text-uppercase text-muted">Mes</label>
      <select name="month" class="form-select">
        {% for item in month_options %}
          <option value="{{ item.value }}" {% if item.value == selected_month %}selected{% endif %}>{{ item.label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-auto d-flex gap-2 flex-wrap">
      <button type="submit" class="btn btn-primary">Actualizar</button>
      <a class="btn btn-outline-secondary" href="{{ export_mes_url }}">Descargar CSV (Mes)</a>
      <a class="btn btn-outline-secondary" href="{{ export_anio_url }}">Descargar CSV (Año)</a>
    </div>
  </form>

  <div class="row g-3 mb-4">
    <div class="col-md-6 col-xl-3">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-body">
          <span class="text-muted d-block">Reservadas ({{ mes_actual_label|title }})</span>
          <h3 class="fw-semibold mb-0">{{ total_reservadas_mes }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-body">
          <span class="text-muted d-block">Canceladas ({{ mes_actual_label|title }})</span>
          <h3 class="fw-semibold mb-0">{{ total_canceladas_mes }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-body">
          <span class="text-muted d-block">No tomadas ({{ mes_actual_label|title }})</span>
          <h3 class="fw-semibold mb-0">{{ total_no_tomadas_mes }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-body">
          <span class="text-muted d-block">Tasa de cancelación</span>
          <h3 class="fw-semibold mb-0">{{ tasa_cancelacion_mes }}%</h3>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    {% if alcance_global and rendimiento_veterinarios %}
      <div class="col-lg-7">
        <div class="card dashboard-card shadow-sm border-0 h-100">
          <div class="card-header border-0 bg-transparent py-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="d-flex flex-column">
              <h5 class="mb-0 fw-semibold text-primary">Rendimiento por profesional</h5>
              <span class="badge text-bg-light text-muted" style="width: fit-content;">{{ mes_actual_label|title }}</span>
            </div>
            <button class="btn btn-sm btn-outline-secondary"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-rendimiento"
                    aria-expanded="true"
                    aria-controls="collapse-rendimiento"
                    data-toggle-text>
              Ocultar
            </button>
          </div>
          <div id="collapse-rendimiento" class="collapse show">
            <div class="card-body">
              {% if rendimiento_veterinarios %}
                <div class="chart-area mb-4" style="height: 360px;">
                  <canvas id="chart-rendimiento"></canvas>
                </div>
                <div class="table-responsive">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr>
                        <th>Profesional</th>
                        <th class="text-center">Reservadas</th>
                        <th class="text-center">Canceladas</th>
                        <th class="text-center">No tomadas</th>
                        <th class="text-center">Asistencias</th>
                        <th class="text-center">Pendientes</th>
                        <th class="text-center">Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in rendimiento_veterinarios %}
                        <tr>
                          <td>{{ item.profesional }}</td>
                          <td class="text-center">{{ item.reservadas }}</td>
                          <td class="text-center">{{ item.canceladas }}</td>
                          <td class="text-center">{{ item.no_tomadas }}</td>
                          <td class="text-center">{{ item.asistencias }}</td>
                          <td class="text-center">{{ item.pendientes }}</td>
                          <td class="text-center fw-semibold">{{ item.total }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="alert alert-soft mb-0">Aún no hay datos de rendimiento disponibles para el mes seleccionado.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="{% if alcance_global and rendimiento_veterinarios %}col-lg-5{% else %}col-12{% endif %}">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-header border-0 bg-transparent py-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="d-flex flex-column">
            <h5 class="mb-0 fw-semibold text-primary">Tipos de mascota más atendidos</h5>
            <span class="badge text-bg-light text-muted" style="width: fit-content;">Datos de {{ mascotas_populares_label }}</span>
          </div>
          <button class="btn btn-sm btn-outline-secondary"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse-mascotas"
                  aria-expanded="true"
                  aria-controls="collapse-mascotas"
                  data-toggle-text>
            Ocultar
          </button>
        </div>
        <div id="collapse-mascotas" class="collapse show">
          <div class="card-body">
            {% if mascotas_populares %}
              <div class="chart-area mb-4" style="height: 320px;">
                <canvas id="chart-mascotas"></canvas>
              </div>
              <div class="table-responsive">
                <table class="table align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Tipo</th>
                      <th>Especie registrada</th>
                      <th>Raza</th>
                      <th class="text-center">Citas</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for mascota in mascotas_populares %}
                      <tr>
                        <td>{{ mascota.tipo }}</td>
                        <td>{{ mascota.especie }}</td>
                        <td>{{ mascota.raza }}</td>
                        <td class="text-center fw-semibold">{{ mascota.total }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-soft mb-0">Aún no hay datos de mascotas para el mes seleccionado.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h4 class="mb-0 fw-semibold text-primary">Visualizaciones interactivas</h4>
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false">
        Mostrar / ocultar
      </button>
      <div class="dropdown-menu dropdown-menu-end p-3 shadow-sm"
           style="min-width: 260px;">
        <p class="text-muted small mb-2">Selecciona las gráficas visibles en el panel.</p>
        <div class="form-check form-switch mb-2">
          <input class="form-check-input chart-visibility-toggle"
                 type="checkbox"
                 role="switch"
                 id="toggle-resumen"
                 data-chart-target="#chart-resumen-card"
                 checked />
          <label class="form-check-label" for="toggle-resumen">Resumen mensual</label>
        </div>
        <div class="form-check form-switch mb-2">
          <input class="form-check-input chart-visibility-toggle"
                 type="checkbox"
                 role="switch"
                 id="toggle-tendencias"
                 data-chart-target="#chart-tendencias-card"
                 checked />
          <label class="form-check-label" for="toggle-tendencias">Tendencias mensuales</label>
        </div>
        <div class="form-check form-switch">
          <input class="form-check-input chart-visibility-toggle"
                 type="checkbox"
                 role="switch"
                 id="toggle-servicios"
                 data-chart-target="#chart-servicios-card"
                 checked />
          <label class="form-check-label" for="toggle-servicios">Servicios más reservados</label>
        </div>
      </div>
    </div>
  </div>

  <div class="card dashboard-card shadow-sm border-0 mb-4" id="chart-resumen-card">
    <div class="card-header border-0 bg-transparent py-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
      <h5 class="mb-0 fw-semibold text-primary">Resumen gráfico del mes</h5>
      <span class="badge text-bg-light text-muted">{{ mes_actual_label|title }}</span>
    </div>
    <div class="card-body">
      <div class="chart-area" style="height: 320px;">
        <canvas id="chart-resumen"></canvas>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-7" id="chart-tendencias-card">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-header border-0 bg-transparent py-3">
          <h5 class="mb-0 fw-semibold text-primary">Tendencias mensuales</h5>
        </div>
        <div class="card-body">
          {% if tendencias_mensuales %}
            <div class="chart-area mb-4" style="height: 320px;">
              <canvas id="chart-tendencias"></canvas>
            </div>
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th>Mes</th>
                    <th class="text-center">Reservadas</th>
                    <th class="text-center">Canceladas</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in tendencias_mensuales %}
                    <tr>
                      <td>{{ item.periodo }}</td>
                      <td class="text-center">{{ item.reservadas }}</td>
                      <td class="text-center">{{ item.canceladas }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-soft mb-0">No se encontraron datos suficientes para calcular tendencias.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card dashboard-card shadow-sm border-0 mb-4">
        <div class="card-header border-0 bg-transparent py-3">
          <h5 class="mb-0 fw-semibold text-primary">Asistencias del mes</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Confirmadas
              <span class="badge text-bg-success rounded-pill">{{ total_asistencias_mes }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Pendientes
              <span class="badge text-bg-warning rounded-pill">{{ total_pendientes_asistencia_mes }}</span>
            </li>
          </ul>
        </div>
      </div>
      <div class="card dashboard-card shadow-sm border-0" id="chart-servicios-card">
        <div class="card-header border-0 bg-transparent py-3">
          <h5 class="mb-0 fw-semibold text-primary">Servicios más reservados</h5>
        </div>
        <div class="card-body">
          {% if servicios_reservas %}
            <div class="chart-area mb-4" style="height: 280px;">
              <canvas id="chart-servicios"></canvas>
            </div>
            <ul class="list-group list-group-flush">
              {% for servicio in servicios_reservas %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  {{ servicio.servicio }}
                  <span class="badge text-bg-primary rounded-pill">{{ servicio.total }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="alert alert-soft mb-0">Aún no hay reservas en el mes actual.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <div class="card dashboard-card shadow-sm border-0 mt-4">
    <div class="card-header border-0 bg-transparent py-3">
      <h5 class="mb-0 fw-semibold text-primary">Agenda próxima (7 días)</h5>
    </div>
    <div class="card-body">
      {% if proximas_citas %}
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Mascota</th>
                <th>Servicio</th>
              </tr>
            </thead>
            <tbody>
              {% for cita in proximas_citas %}
                <tr>
                  <td>{{ cita.fecha|date:"d/m/Y H:i" }}</td>
                  <td>{{ cita.cliente.nombre_cliente|default:"-" }}</td>
                  <td>{{ cita.mascota.nombre|default:"-" }}</td>
                  <td>{{ cita.get_servicio_display }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-soft mb-0">No hay citas reservadas para los próximos días.</div>
      {% endif %}
    </div>
  </div>
  {% if alcance_global and rendimiento_veterinarios %}
    {{ rendimiento_veterinarios|json_script:"rendimiento-veterinarios-data" }}
  {% endif %}
  {% if mascotas_populares %}
    {{ mascotas_populares|json_script:"mascotas-populares-data" }}
  {% endif %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    (function () {
      const toggles = document.querySelectorAll('.chart-visibility-toggle');
      toggles.forEach((toggle) => {
        const targetSelector = toggle.getAttribute('data-chart-target');
        if (!targetSelector) return;
        const target = document.querySelector(targetSelector);
        if (!target) return;

        const updateVisibility = () => {
          target.classList.toggle('d-none', !toggle.checked);
        };

        toggle.addEventListener('change', updateVisibility);
        updateVisibility();
      });

      const collapseButtons = document.querySelectorAll('[data-toggle-text]');
      collapseButtons.forEach((button) => {
        const targetSelector = button.getAttribute('data-bs-target');
        if (!targetSelector) {
          return;
        }
        const target = document.querySelector(targetSelector);
        if (!target) {
          return;
        }

        const updateLabel = () => {
          const isShown = target.classList.contains('show');
          button.innerText = isShown ? 'Ocultar' : 'Mostrar';
        };

        target.addEventListener('shown.bs.collapse', updateLabel);
        target.addEventListener('hidden.bs.collapse', updateLabel);
        button.addEventListener('click', () => {
          window.setTimeout(updateLabel, 0);
        });

        updateLabel();
      });

      if (!window.Chart) {
        return;
      }

      const parseJSONData = (elementId) => {
        const element = document.getElementById(elementId);
        if (!element) {
          return null;
        }
        try {
          return JSON.parse(element.textContent);
        } catch (error) {
          console.warn('No se pudieron leer los datos del gráfico', error);
          return null;
        }
      };

      const chartPalette = {
        primary: '#0d6efd',
        secondary: '#6c757d',
        success: '#198754',
        danger: '#dc3545',
        warning: '#ffc107'
      };

      const rendimientoCanvas = document.getElementById('chart-rendimiento');
      if (rendimientoCanvas) {
        const rendimientoData = parseJSONData('rendimiento-veterinarios-data');
        if (Array.isArray(rendimientoData) && rendimientoData.length) {
          const labels = rendimientoData.map((item) => item.profesional);
          const metricConfigs = [
            { key: 'reservadas', label: 'Reservadas', color: chartPalette.primary },
            { key: 'canceladas', label: 'Canceladas', color: chartPalette.danger },
            { key: 'no_tomadas', label: 'No tomadas', color: chartPalette.secondary },
            { key: 'asistencias', label: 'Asistencias', color: chartPalette.success },
            { key: 'pendientes', label: 'Pendientes', color: chartPalette.warning }
          ];

          const rendimientoChart = new Chart(rendimientoCanvas, {
            type: 'bar',
            data: {
              labels,
              datasets: metricConfigs.map((config) => ({
                label: config.label,
                data: rendimientoData.map((item) => item[config.key] || 0),
                backgroundColor: config.color,
                borderRadius: 6,
                maxBarThickness: 48
              }))
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  stacked: false
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              },
              plugins: {
                legend: {
                  position: 'bottom'
                },
                tooltip: {
                  callbacks: {
                    label: (context) => `${context.dataset.label}: ${context.formattedValue}`
                  }
                }
              }
            }
          });
        }
      }

      const mascotasCanvas = document.getElementById('chart-mascotas');
      if (mascotasCanvas) {
        const mascotasData = parseJSONData('mascotas-populares-data');
        if (Array.isArray(mascotasData) && mascotasData.length) {
          const colorCycle = [
            chartPalette.primary,
            chartPalette.success,
            chartPalette.warning,
            chartPalette.danger,
            chartPalette.secondary
          ];

          const mascotasChart = new Chart(mascotasCanvas, {
            type: 'bar',
            data: {
              labels: mascotasData.map((item) => {
                const tipo = item.tipo || item.especie || 'Mascota';
                const raza = item.raza || 'Sin raza';
                return `${tipo} · ${raza}`;
              }),
              datasets: [
                {
                  label: 'Citas',
                  data: mascotasData.map((item) => item.total || 0),
                  backgroundColor: mascotasData.map((_, index) => colorCycle[index % colorCycle.length]),
                  borderRadius: 6,
                  maxBarThickness: 36
                }
              ]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              },
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const dataIndex = context.dataIndex;
                      const dataItem = mascotasData[dataIndex] || {};
                      const tipo = dataItem.tipo || dataItem.especie || 'Mascota';
                      const especie = dataItem.especie || 'Sin especie';
                      const raza = dataItem.raza || 'Sin raza';
                      return `${context.formattedValue} citas — ${tipo} (${especie}, ${raza})`;
                    }
                  }
                }
              }
            }
          });
        }
      }

      const resumenCanvas = document.getElementById('chart-resumen');
      if (resumenCanvas) {
        const resumenChart = new Chart(resumenCanvas, {
          type: 'bar',
          data: {
            labels: ['Reservadas', 'Canceladas', 'No tomadas'],
            datasets: [
              {
                label: 'Citas',
                data: [
                  {{ total_reservadas_mes|default:0 }},
                  {{ total_canceladas_mes|default:0 }},
                  {{ total_no_tomadas_mes|default:0 }}
                ],
                backgroundColor: [
                  chartPalette.primary,
                  chartPalette.danger,
                  chartPalette.secondary
                ],
                borderRadius: 6,
                maxBarThickness: 60
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.formattedValue} citas`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
      }

      const tendenciasCanvas = document.getElementById('chart-tendencias');
      if (tendenciasCanvas) {
        const tendenciasLabels = [{% for item in tendencias_mensuales %}'{{ item.periodo|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
        const tendenciasReservadas = [{% for item in tendencias_mensuales %}{{ item.reservadas|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
        const tendenciasCanceladas = [{% for item in tendencias_mensuales %}{{ item.canceladas|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];

        if (tendenciasLabels.length) {
          const tendenciasChart = new Chart(tendenciasCanvas, {
            type: 'line',
            data: {
              labels: tendenciasLabels,
              datasets: [
                {
                  label: 'Reservadas',
                  data: tendenciasReservadas,
                  borderColor: chartPalette.primary,
                  backgroundColor: 'rgba(13, 110, 253, 0.15)',
                  tension: 0.3,
                  fill: true,
                  pointRadius: 4,
                  pointHoverRadius: 6
                },
                {
                  label: 'Canceladas',
                  data: tendenciasCanceladas,
                  borderColor: chartPalette.danger,
                  backgroundColor: 'rgba(220, 53, 69, 0.1)',
                  tension: 0.3,
                  fill: true,
                  pointRadius: 4,
                  pointHoverRadius: 6
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom'
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            }
          });
        }
      }

      const serviciosCanvas = document.getElementById('chart-servicios');
      if (serviciosCanvas) {
        const serviciosLabels = [{% for servicio in servicios_reservas %}'{{ servicio.servicio|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
        const serviciosTotales = [{% for servicio in servicios_reservas %}{{ servicio.total|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];

        if (serviciosLabels.length) {
          const serviciosChart = new Chart(serviciosCanvas, {
            type: 'doughnut',
            data: {
              labels: serviciosLabels,
              datasets: [
                {
                  label: 'Reservas',
                  data: serviciosTotales,
                  backgroundColor: serviciosLabels.map((_, index) => {
                    const palette = [
                      chartPalette.primary,
                      chartPalette.success,
                      chartPalette.warning,
                      chartPalette.danger,
                      chartPalette.secondary
                    ];
                    return palette[index % palette.length];
                  }),
                  borderWidth: 1
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom'
                }
              }
            }
          });
        }
      }
    })();
  </script>

{% endblock content %}