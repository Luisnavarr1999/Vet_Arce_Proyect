{% extends "./master.html" %}
{% block title %}
  Dashboard
{% endblock title %}
{% block content %}
  <section class="dashboard-hero card border-0 shadow-sm mb-4">
    <div class="card-body">
      <h2 class="fw-semibold mb-2">Indicadores operativos</h2>
      <p class="mb-0 text-muted">
        Vista basada en {{ alcance_global|yesno:"toda la veterinaria,sus citas asignadas" }}.
      </p>
    </div>
  </section>

  <form method="get" class="row g-3 align-items-end mb-4">
    <div class="col-sm-6 col-md-3">
      <label class="form-label small text-uppercase text-muted">Año</label>
      <select name="year" class="form-select">
        {% for year in year_options %}
          <option value="{{ year }}" {% if year == selected_year %}selected{% endif %}>{{ year }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-sm-6 col-md-3">
      <label class="form-label small text-uppercase text-muted">Mes</label>
      <select name="month" class="form-select">
        {% for item in month_options %}
          <option value="{{ item.value }}" {% if item.value == selected_month %}selected{% endif %}>{{ item.label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-auto d-flex gap-2 flex-wrap">
      <button type="submit" class="btn btn-primary">Actualizar</button>
      <a class="btn btn-outline-secondary" href="{{ export_mes_url }}">Descargar CSV (Mes)</a>
      <a class="btn btn-outline-secondary" href="{{ export_anio_url }}">Descargar CSV (Año)</a>
    </div>
  </form>

  <div class="row g-3 mb-4">
    <div class="col-md-6 col-xl-3">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-body">
          <span class="text-muted d-block">Reservadas ({{ mes_actual_label|title }})</span>
          <h3 class="fw-semibold mb-0">{{ total_reservadas_mes }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-body">
          <span class="text-muted d-block">Canceladas ({{ mes_actual_label|title }})</span>
          <h3 class="fw-semibold mb-0">{{ total_canceladas_mes }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-body">
          <span class="text-muted d-block">No tomadas ({{ mes_actual_label|title }})</span>
          <h3 class="fw-semibold mb-0">{{ total_no_tomadas_mes }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-6 col-xl-3">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-body">
          <span class="text-muted d-block">Tasa de cancelación</span>
          <h3 class="fw-semibold mb-0">{{ tasa_cancelacion_mes }}%</h3>
        </div>
      </div>
    </div>
  </div>

  <div class="row g-3 mb-4">
    {% if alcance_global and rendimiento_veterinarios %}
      <div class="col-lg-7">
        <div class="card dashboard-card shadow-sm border-0 h-100">
          <div class="card-header border-0 bg-transparent py-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="d-flex flex-column">
              <h5 class="mb-0 fw-semibold text-primary">Rendimiento por profesional</h5>
              <span class="badge text-bg-light text-muted" style="width: fit-content;">{{ mes_actual_label|title }}</span>
            </div>
            <button class="btn btn-sm btn-outline-secondary"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#collapse-rendimiento"
                    aria-expanded="true"
                    aria-controls="collapse-rendimiento"
                    data-toggle-text>
              Ocultar
            </button>
          </div>
          <div id="collapse-rendimiento" class="collapse show">
            <div class="card-body">
              {% if rendimiento_veterinarios %}
                <div class="d-flex flex-column flex-lg-row align-items-lg-center justify-content-lg-between gap-3 mb-4">
                  <div class="d-flex flex-wrap align-items-center gap-2" data-rendimiento-filter-group>
                    <span class="text-muted small text-uppercase fw-semibold me-1">Profesionales</span>
                    {% for item in rendimiento_veterinarios %}
                      <div class="form-check form-check-inline mb-0">
                        <input class="form-check-input"
                               type="checkbox"
                               id="rendimiento-filter-{{ forloop.counter }}"
                               value="{{ item.profesional }}"
                               data-rendimiento-filter
                               checked />
                        <label class="form-check-label small fw-semibold"
                               for="rendimiento-filter-{{ forloop.counter }}">
                          {{ item.profesional }}
                        </label>
                      </div>
                    {% endfor %}
                  </div>
                  <div class="d-flex flex-wrap gap-2">
                    <button type="button" class="btn btn-sm btn-outline-primary" data-rendimiento-reset>
                      Mostrar todos
                    </button>
                  </div>
                </div>
                <div class="chart-area mb-4" style="height: 360px;">
                  <canvas id="chart-rendimiento"></canvas>
                </div>
                <div class="table-responsive rendimiento-table-wrapper">
                  <table class="table align-middle mb-0">
                    <thead>
                      <tr>
                        <th>Profesional</th>
                        <th class="text-center">Reservadas</th>
                        <th class="text-center">Canceladas</th>
                        <th class="text-center">No tomadas</th>
                        <th class="text-center">Asistencias</th>
                        <th class="text-center">Pendientes</th>
                        <th class="text-center">Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in rendimiento_veterinarios %}
                        <tr data-rendimiento-row="{{ item.profesional }}">
                          <td>{{ item.profesional }}</td>
                          <td class="text-center">{{ item.reservadas }}</td>
                          <td class="text-center">{{ item.canceladas }}</td>
                          <td class="text-center">{{ item.no_tomadas }}</td>
                          <td class="text-center">{{ item.asistencias }}</td>
                          <td class="text-center">{{ item.pendientes }}</td>
                          <td class="text-center fw-semibold">{{ item.total }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <div class="alert alert-soft mb-0">Aún no hay datos de rendimiento disponibles para el mes seleccionado.</div>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    {% endif %}

    <div class="{% if alcance_global and rendimiento_veterinarios %}col-lg-5{% else %}col-12{% endif %}">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-header border-0 bg-transparent py-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
          <div class="d-flex flex-column">
            <h5 class="mb-0 fw-semibold text-primary">Tipos de mascota más atendidos</h5>
            <span class="badge text-bg-light text-muted" style="width: fit-content;">Datos de {{ mascotas_populares_label }}</span>
          </div>
          <button class="btn btn-sm btn-outline-secondary"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapse-mascotas"
                  aria-expanded="true"
                  aria-controls="collapse-mascotas"
                  data-toggle-text>
            Ocultar
          </button>
        </div>
        <div id="collapse-mascotas" class="collapse show">
          <div class="card-body">
            {% if mascotas_populares %}
              <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-3">
                <div class="d-flex flex-column">
                  <span class="text-muted small text-uppercase fw-semibold">Visualización</span>
                  <span class="text-muted small">Cambia entre gráfico de barras y gráfico pastel.</span>
                </div>
                <div class="btn-group btn-group-sm" role="group" data-mascotas-chart-toggle>
                  <button type="button"
                          class="btn btn-outline-primary active"
                          data-mascotas-chart="bar">
                    Barras
                  </button>
                  <button type="button"
                          class="btn btn-outline-primary"
                          data-mascotas-chart="pie"
                          {% if not mascotas_resumen_tipo %}disabled{% endif %}>
                    Pastel
                  </button>
                </div>
              </div>
              <div class="chart-area mb-4" data-mascotas-chart-container="bar" style="height: 320px;">
                <canvas id="chart-mascotas-bar"></canvas>
              </div>
              <div class="chart-area mb-4 d-none" data-mascotas-chart-container="pie" style="height: 320px;">
                <canvas id="chart-mascotas-pie"></canvas>
              </div>
              <div class="mascotas-detail d-none" data-mascotas-detail>
                <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-2">
                  <h6 class="mb-0 fw-semibold text-primary">
                    Razas para: <span data-mascotas-detail-label></span>
                  </h6>
                  <button type="button"
                          class="btn btn-sm btn-outline-secondary"
                          data-mascotas-detail-reset>
                    Ver todos los tipos
                  </button>
                </div>
                <div class="chart-area" style="height: 260px;">
                  <canvas id="chart-mascotas-detalle"></canvas>
                </div>
              </div>
              <div class="table-responsive mascotas-table-scroll">
                <table class="table align-middle mb-0">
                  <thead>
                    <tr>
                      <th>Tipo</th>
                      <th>Especie registrada</th>
                      <th>Raza</th>
                      <th class="text-center">Citas</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for mascota in mascotas_populares %}
                      <tr>
                        <td>{{ mascota.tipo }}</td>
                        <td>{{ mascota.especie }}</td>
                        <td>{{ mascota.raza }}</td>
                        <td class="text-center fw-semibold">{{ mascota.total }}</td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <div class="alert alert-soft mb-0">Aún no hay datos de mascotas para el mes seleccionado.</div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
    <h4 class="mb-0 fw-semibold text-primary">Visualizaciones interactivas</h4>
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              aria-expanded="false">
        Mostrar / ocultar
      </button>
      <div class="dropdown-menu dropdown-menu-end p-3 shadow-sm"
           style="min-width: 260px;">
        <p class="text-muted small mb-2">Selecciona las gráficas visibles en el panel.</p>
        <div class="form-check form-switch mb-2">
          <input class="form-check-input chart-visibility-toggle"
                 type="checkbox"
                 role="switch"
                 id="toggle-resumen"
                 data-chart-target="#chart-resumen-card"
                 checked />
          <label class="form-check-label" for="toggle-resumen">Resumen mensual</label>
        </div>
        <div class="form-check form-switch mb-2">
          <input class="form-check-input chart-visibility-toggle"
                 type="checkbox"
                 role="switch"
                 id="toggle-tendencias"
                 data-chart-target="#chart-tendencias-card"
                 checked />
          <label class="form-check-label" for="toggle-tendencias">Tendencias mensuales</label>
        </div>
        <div class="form-check form-switch">
          <input class="form-check-input chart-visibility-toggle"
                 type="checkbox"
                 role="switch"
                 id="toggle-servicios"
                 data-chart-target="#chart-servicios-card"
                 checked />
          <label class="form-check-label" for="toggle-servicios">Servicios más reservados</label>
        </div>
      </div>
    </div>
  </div>

  <div class="card dashboard-card shadow-sm border-0 mb-4" id="chart-resumen-card">
    <div class="card-header border-0 bg-transparent py-3 d-flex flex-wrap justify-content-between align-items-center gap-2">
      <h5 class="mb-0 fw-semibold text-primary">Resumen gráfico del mes</h5>
      <span class="badge text-bg-light text-muted">{{ mes_actual_label|title }}</span>
    </div>
    <div class="card-body">
      <div class="chart-area" style="height: 320px;">
        <canvas id="chart-resumen"></canvas>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-7" id="chart-tendencias-card">
      <div class="card dashboard-card shadow-sm border-0 h-100">
        <div class="card-header border-0 bg-transparent py-3">
          <h5 class="mb-0 fw-semibold text-primary">Tendencias mensuales</h5>
        </div>
        <div class="card-body">
          {% if tendencias_mensuales %}
            <div class="chart-area mb-4" style="height: 320px;">
              <canvas id="chart-tendencias"></canvas>
            </div>
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead>
                  <tr>
                    <th>Mes</th>
                    <th class="text-center">Reservadas</th>
                    <th class="text-center">Canceladas</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in tendencias_mensuales %}
                    <tr>
                      <td>{{ item.periodo }}</td>
                      <td class="text-center">{{ item.reservadas }}</td>
                      <td class="text-center">{{ item.canceladas }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="alert alert-soft mb-0">No se encontraron datos suficientes para calcular tendencias.</div>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="col-lg-5">
      <div class="card dashboard-card shadow-sm border-0 mb-4">
        <div class="card-header border-0 bg-transparent py-3">
          <h5 class="mb-0 fw-semibold text-primary">Asistencias del mes</h5>
        </div>
        <div class="card-body">
          <ul class="list-group list-group-flush">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Confirmadas
              <span class="badge text-bg-success rounded-pill">{{ total_asistencias_mes }}</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Pendientes
              <span class="badge text-bg-warning rounded-pill">{{ total_pendientes_asistencia_mes }}</span>
            </li>
          </ul>
        </div>
      </div>
      <div class="card dashboard-card shadow-sm border-0" id="chart-servicios-card">
        <div class="card-header border-0 bg-transparent py-3">
          <h5 class="mb-0 fw-semibold text-primary">Servicios más reservados</h5>
        </div>
        <div class="card-body">
          {% if servicios_reservas %}
            <div class="chart-area mb-4" style="height: 280px;">
              <canvas id="chart-servicios"></canvas>
            </div>
            <ul class="list-group list-group-flush">
              {% for servicio in servicios_reservas %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  {{ servicio.servicio }}
                  <span class="badge text-bg-primary rounded-pill">{{ servicio.total }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <div class="alert alert-soft mb-0">Aún no hay reservas en el mes actual.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

  <style>
    .mascotas-table-scroll {
      max-height: 260px;
      overflow-y: auto;
    }
  </style>

  <div class="card dashboard-card shadow-sm border-0 mt-4">
    <div class="card-header border-0 bg-transparent py-3">
      <h5 class="mb-0 fw-semibold text-primary">Agenda próxima (7 días)</h5>
    </div>
    <div class="card-body">
      {% if proximas_citas %}
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Mascota</th>
                <th>Servicio</th>
              </tr>
            </thead>
            <tbody>
              {% for cita in proximas_citas %}
                <tr>
                  <td>{{ cita.fecha|date:"d/m/Y H:i" }}</td>
                  <td>{{ cita.cliente.nombre_cliente|default:"-" }}</td>
                  <td>{{ cita.mascota.nombre|default:"-" }}</td>
                  <td>{{ cita.get_servicio_display }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="alert alert-soft mb-0">No hay citas reservadas para los próximos días.</div>
      {% endif %}
    </div>
  </div>
  {% if alcance_global and rendimiento_veterinarios %}
    {{ rendimiento_veterinarios|json_script:"rendimiento-veterinarios-data" }}
  {% endif %}
  {% if mascotas_populares %}
    {{ mascotas_populares|json_script:"mascotas-populares-data" }}
    {{ mascotas_resumen_tipo|json_script:"mascotas-por-tipo-data" }}
  {% endif %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  <script>
    (function () {
      const toggles = document.querySelectorAll('.chart-visibility-toggle');
      toggles.forEach((toggle) => {
        const targetSelector = toggle.getAttribute('data-chart-target');
        if (!targetSelector) return;
        const target = document.querySelector(targetSelector);
        if (!target) return;

        const updateVisibility = () => {
          target.classList.toggle('d-none', !toggle.checked);
        };

        toggle.addEventListener('change', updateVisibility);
        updateVisibility();
      });

      const collapseButtons = document.querySelectorAll('[data-toggle-text]');
      collapseButtons.forEach((button) => {
        const targetSelector = button.getAttribute('data-bs-target');
        if (!targetSelector) {
          return;
        }
        const target = document.querySelector(targetSelector);
        if (!target) {
          return;
        }

        const updateLabel = () => {
          const isShown = target.classList.contains('show');
          button.innerText = isShown ? 'Ocultar' : 'Mostrar';
        };

        target.addEventListener('shown.bs.collapse', updateLabel);
        target.addEventListener('hidden.bs.collapse', updateLabel);
        button.addEventListener('click', () => {
          window.setTimeout(updateLabel, 0);
        });

        updateLabel();
      });

      if (!window.Chart) {
        return;
      }

      const parseJSONData = (elementId) => {
        const element = document.getElementById(elementId);
        if (!element) {
          return null;
        }
        try {
          return JSON.parse(element.textContent);
        } catch (error) {
          console.warn('No se pudieron leer los datos del gráfico', error);
          return null;
        }
      };

      const chartPalette = {
        primary: '#0d6efd',
        secondary: '#6c757d',
        success: '#198754',
        danger: '#dc3545',
        warning: '#ffc107'
      };

      const rendimientoCanvas = document.getElementById('chart-rendimiento');
      if (rendimientoCanvas) {
        const rendimientoData = parseJSONData('rendimiento-veterinarios-data');
        if (Array.isArray(rendimientoData) && rendimientoData.length) {
          const labels = rendimientoData.map((item) => item.profesional);
          const metricConfigs = [
            { key: 'reservadas', label: 'Reservadas', color: chartPalette.primary },
            { key: 'canceladas', label: 'Canceladas', color: chartPalette.danger },
            { key: 'no_tomadas', label: 'No tomadas', color: chartPalette.secondary },
            { key: 'asistencias', label: 'Asistencias', color: chartPalette.success },
            { key: 'pendientes', label: 'Pendientes', color: chartPalette.warning }
          ];

          const rendimientoChart = new Chart(rendimientoCanvas, {
            type: 'bar',
            data: {
              labels: rendimientoData.map((item) => item.profesional),
              datasets: metricConfigs.map((config) => ({
                label: config.label,
                data: rendimientoData.map((item) => item[config.key] || 0),
                backgroundColor: config.color,
                borderRadius: 6,
                maxBarThickness: 48,
                _dataKey: config.key
              }))
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                x: {
                  stacked: false
                },
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              },
              plugins: {
                legend: {
                  position: 'bottom'
                },
                tooltip: {
                  callbacks: {
                    label: (context) => `${context.dataset.label}: ${context.formattedValue}`
                  }
                }
              }
            }
          });

          const rendimientoFilterCheckboxes = document.querySelectorAll('[data-rendimiento-filter]');
          const rendimientoResetButton = document.querySelector('[data-rendimiento-reset]');
          const rendimientoTableRows = document.querySelectorAll('[data-rendimiento-row]');

          const updateRendimientoVisuals = () => {
            let filteredData = rendimientoData;
            let activeSet = null;

            if (rendimientoFilterCheckboxes.length) {
              let activeCheckboxes = Array.from(rendimientoFilterCheckboxes).filter((checkbox) => checkbox.checked);

              if (!activeCheckboxes.length) {
                activeCheckboxes = Array.from(rendimientoFilterCheckboxes);
                activeCheckboxes.forEach((checkbox) => {
                  checkbox.checked = true;
                });
              }

              activeSet = new Set(activeCheckboxes.map((checkbox) => checkbox.value));
              filteredData = rendimientoData.filter((item) => activeSet.has(item.profesional));
            }

            rendimientoChart.data.labels = filteredData.map((item) => item.profesional);
            rendimientoChart.data.datasets.forEach((dataset) => {
              const dataKey = dataset._dataKey;
              dataset.data = filteredData.map((item) => item[dataKey] || 0);
            });
            rendimientoChart.update();

            if (rendimientoTableRows.length) {
              if (activeSet) {
                rendimientoTableRows.forEach((row) => {
                  const profesional = row.getAttribute('data-rendimiento-row');
                  row.classList.toggle('d-none', !activeSet.has(profesional));
                });
              } else {
                rendimientoTableRows.forEach((row) => row.classList.remove('d-none'));
              }
            }
          };

          if (rendimientoFilterCheckboxes.length) {
            rendimientoFilterCheckboxes.forEach((checkbox) => {
              checkbox.addEventListener('change', updateRendimientoVisuals);
            });
          }

          if (rendimientoResetButton) {
            rendimientoResetButton.addEventListener('click', () => {
              rendimientoFilterCheckboxes.forEach((checkbox) => {
                checkbox.checked = true;
              });
              updateRendimientoVisuals();
            });
          }

          updateRendimientoVisuals();
        }
      }

      const mascotasBarCanvas = document.getElementById('chart-mascotas-bar');
      const mascotasPieCanvas = document.getElementById('chart-mascotas-pie');
      const mascotasDetailCanvas = document.getElementById('chart-mascotas-detalle');
      const mascotasChartToggleButtons = document.querySelectorAll('[data-mascotas-chart]');
      const mascotasChartContainers = document.querySelectorAll('[data-mascotas-chart-container]');
      const mascotasDetailWrapper = document.querySelector('[data-mascotas-detail]');
      const mascotasDetailLabel = document.querySelector('[data-mascotas-detail-label]');
      const mascotasDetailReset = document.querySelector('[data-mascotas-detail-reset]');

      let mascotasBarChart = null;
      let mascotasPieChart = null;
      let mascotasDetailChart = null;

      const mascotasData = parseJSONData('mascotas-populares-data') || [];
      const mascotasPorTipo = parseJSONData('mascotas-por-tipo-data') || [];

      const createMascotasBarChart = () => {
        if (!mascotasBarCanvas || mascotasBarChart || !mascotasData.length) {
          return;
        }

        mascotasBarChart = new Chart(mascotasBarCanvas, {
          type: 'bar',
          data: {
            labels: mascotasData.map((item) => {
              const tipo = item.tipo || item.especie || 'Mascota';
              const raza = item.raza || 'Sin información';
              return `${tipo} · ${raza}`;
            }),
            datasets: [
              {
                label: 'Citas por raza',
                data: mascotasData.map((item) => item.total || 0),
                backgroundColor: chartPalette.primary,
                borderRadius: 6,
                maxBarThickness: 48
              }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.formattedValue} citas`
                }
              }
            }
          }
        });
      };

      const createMascotasPieChart = () => {
        if (!mascotasPieCanvas || mascotasPieChart || !mascotasPorTipo.length) {
          return;
        }

        const basePalette = [
          chartPalette.primary,
          chartPalette.success,
          chartPalette.warning,
          chartPalette.danger,
          chartPalette.secondary
        ];

        mascotasPieChart = new Chart(mascotasPieCanvas, {
          type: 'doughnut',
          data: {
            labels: mascotasPorTipo.map((item) => item.tipo || 'Mascota'),
            datasets: [
              {
                data: mascotasPorTipo.map((item) => item.total || 0),
                backgroundColor: mascotasPorTipo.map((_, index) => basePalette[index % basePalette.length]),
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { position: 'bottom' },
              tooltip: {
                callbacks: {
                  label: (context) => {
                    const label = context.label || 'Mascota';
                    return `${label}: ${context.formattedValue} citas`;
                  }
                }
              }
            },
            onClick: (_, elements) => {
              if (!elements.length) {
                return;
              }
              const index = elements[0].index;
              const tipo = mascotasPorTipo[index];
              if (tipo) {
                renderMascotasDetail(tipo);
              }
            }
          }
        });
      };

      const renderMascotasDetail = (tipoData) => {
        if (!mascotasDetailCanvas || !tipoData) {
          return;
        }

        const razas = Array.isArray(tipoData.razas) ? tipoData.razas : [];
        if (!razas.length) {
          return;
        }

        if (mascotasDetailChart) {
          mascotasDetailChart.destroy();
        }

        mascotasDetailChart = new Chart(mascotasDetailCanvas, {
          type: 'bar',
          data: {
            labels: razas.map((item) => item.raza || 'Sin información'),
            datasets: [
              {
                label: `Citas ({{ tipoData.tipo }})`,
                data: razas.map((item) => item.total || 0),
                backgroundColor: chartPalette.primary,
                borderRadius: 6,
                maxBarThickness: 48
              }
            ]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.formattedValue} citas`
                }
              }
            },
            scales: {
              x: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });

        if (mascotasDetailLabel) {
          mascotasDetailLabel.textContent = tipoData.tipo;
        }

        if (mascotasDetailWrapper) {
          mascotasDetailWrapper.classList.remove('d-none');
        }
      };

      const resetMascotasDetail = () => {
        if (mascotasDetailChart) {
          mascotasDetailChart.destroy();
          mascotasDetailChart = null;
        }
        if (mascotasDetailWrapper) {
          mascotasDetailWrapper.classList.add('d-none');
        }
        if (mascotasDetailLabel) {
          mascotasDetailLabel.textContent = '';
        }
      };

      if (mascotasDetailReset) {
        mascotasDetailReset.addEventListener('click', resetMascotasDetail);
      }

      const toggleMascotasChart = (target) => {
        mascotasChartContainers.forEach((container) => {
          const chartType = container.getAttribute('data-mascotas-chart-container');
          container.classList.toggle('d-none', chartType !== target);
        });

        mascotasChartToggleButtons.forEach((button) => {
          const chartType = button.getAttribute('data-mascotas-chart');
          button.classList.toggle('active', chartType === target);
        });

        if (target === 'bar') {
          resetMascotasDetail();
          createMascotasBarChart();
        } else if (target === 'pie') {
          createMascotasPieChart();
        }
      };

      mascotasChartToggleButtons.forEach((button) => {
        button.addEventListener('click', () => {
          const chartType = button.getAttribute('data-mascotas-chart');
          if (!chartType || button.classList.contains('active') || button.disabled) {
            return;
          }
          toggleMascotasChart(chartType);
        });
      });

      if (mascotasBarCanvas) {
        createMascotasBarChart();
      }
      toggleMascotasChart('bar');

      const resumenCanvas = document.getElementById('chart-resumen');
      if (resumenCanvas) {
        const resumenChart = new Chart(resumenCanvas, {
          type: 'bar',
          data: {
            labels: ['Reservadas', 'Canceladas', 'No tomadas'],
            datasets: [
              {
                label: 'Citas',
                data: [
                  {{ total_reservadas_mes|default:0 }},
                  {{ total_canceladas_mes|default:0 }},
                  {{ total_no_tomadas_mes|default:0 }}
                ],
                backgroundColor: [
                  chartPalette.primary,
                  chartPalette.danger,
                  chartPalette.secondary
                ],
                borderRadius: 6,
                maxBarThickness: 60
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => `${context.formattedValue} citas`
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  precision: 0
                }
              }
            }
          }
        });
      }

      const tendenciasCanvas = document.getElementById('chart-tendencias');
      if (tendenciasCanvas) {
        const tendenciasLabels = [{% for item in tendencias_mensuales %}'{{ item.periodo|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
        const tendenciasReservadas = [{% for item in tendencias_mensuales %}{{ item.reservadas|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];
        const tendenciasCanceladas = [{% for item in tendencias_mensuales %}{{ item.canceladas|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];

        if (tendenciasLabels.length) {
          const tendenciasChart = new Chart(tendenciasCanvas, {
            type: 'line',
            data: {
              labels: tendenciasLabels,
              datasets: [
                {
                  label: 'Reservadas',
                  data: tendenciasReservadas,
                  borderColor: chartPalette.primary,
                  backgroundColor: 'rgba(13, 110, 253, 0.15)',
                  tension: 0.3,
                  fill: true,
                  pointRadius: 4,
                  pointHoverRadius: 6
                },
                {
                  label: 'Canceladas',
                  data: tendenciasCanceladas,
                  borderColor: chartPalette.danger,
                  backgroundColor: 'rgba(220, 53, 69, 0.1)',
                  tension: 0.3,
                  fill: true,
                  pointRadius: 4,
                  pointHoverRadius: 6
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom'
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    precision: 0
                  }
                }
              }
            }
          });
        }
      }

      const serviciosCanvas = document.getElementById('chart-servicios');
      if (serviciosCanvas) {
        const serviciosLabels = [{% for servicio in servicios_reservas %}'{{ servicio.servicio|escapejs }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
        const serviciosTotales = [{% for servicio in servicios_reservas %}{{ servicio.total|default:0 }}{% if not forloop.last %}, {% endif %}{% endfor %}];

        if (serviciosLabels.length) {
          const serviciosChart = new Chart(serviciosCanvas, {
            type: 'doughnut',
            data: {
              labels: serviciosLabels,
              datasets: [
                {
                  label: 'Reservas',
                  data: serviciosTotales,
                  backgroundColor: serviciosLabels.map((_, index) => {
                    const palette = [
                      chartPalette.primary,
                      chartPalette.success,
                      chartPalette.warning,
                      chartPalette.danger,
                      chartPalette.secondary
                    ];
                    return palette[index % palette.length];
                  }),
                  borderWidth: 1
                }
              ]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: {
                  position: 'bottom'
                }
              }
            }
          });
        }
      }
    })();
  </script>

{% endblock content %}
