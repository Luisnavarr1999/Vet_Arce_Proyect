{# Tabla reutilizable para citas #}

<table class="table table-hover align-middle">
  <thead class="table-light">
    <tr>
      <th>NÂ° Cita</th>
      <th>Cliente</th>
      <th>Mascota</th>
      <th>Servicio</th>
      <th>Estado</th>
      <th>Asistencia</th>
      <th>Usuario</th>
      <th>Fecha</th>
      {% if es_home %}
        <th>Ficha</th>
      {% else %}
        <th>Acciones</th>
      {% endif %}
    </tr>
  </thead>
  <tbody>
    {% for cita in citas %}
      <tr>
        <td>{{ cita.n_cita }}</td>
        <td>{{ cita.cliente }}</td>
        <td>{{ cita.mascota }}</td>
        <td>{{ cita.get_servicio_display }}</td>

        {# Estado con badge de color (comparando por cÃ³digo 0/1/2) #}
        <td>
          {% if cita.estado == '0' %}
            <span class="badge bg-success">{{ cita.get_estado_display }}</span>
          {% elif cita.estado == '1' %}
            <span class="badge bg-warning text-dark">{{ cita.get_estado_display }}</span>
          {% elif cita.estado == '2' %}
            <span class="badge bg-danger">{{ cita.get_estado_display }}</span>
          {% elif cita.estado == '3' %}
            <span class="badge bg-secondary">{{ cita.get_estado_display }}</span>
          {% else %}
            {{ cita.get_estado_display }}
          {% endif %}
        </td>

        {# Asistencia con badges visuales #}
        <td>
          {% if cita.asistencia == "A" %}
            <span class="badge bg-success">AsistiÃ³</span>
          {% elif cita.asistencia == "N" %}
            <span class="badge bg-danger">No asistiÃ³</span>
          {% elif cita.asistencia == "P" %}
            <span class="badge bg-secondary">Pendiente</span>
          {% else %}
            <span class="badge bg-light text-muted">Sin registro</span>
          {% endif %}
        </td>

        <td>{{ cita.usuario }}</td>
        <td>
          <div class="fw-semibold">{{ cita.fecha|date:"d/m/Y H:i" }}</div>
          {% if cita.indicadores %}
            <div class="d-flex flex-wrap gap-2 mt-2">
              {% for indicador in cita.indicadores %}
                <span class="badge text-bg-{{ indicador.tipo }}">{{ indicador.texto }}</span>
              {% endfor %}
            </div>
          {% endif %}
        </td>

        {% if es_home %}
          <td>
            {% if cita.mascota %}
              <a href="{% url 'panel_mascota_historial' cita.mascota.id_mascota %}" class="btn btn-outline-primary btn-sm">Ver ficha</a>
            {% else %}
              <span class="badge text-bg-secondary">Sin mascota</span>
            {% endif %}
          </td>
        {% else %}
          <td>
            {# --- Botones de gestiÃ³n --- #}
            {% if perms.paneltrabajador.change_cita %}
              <a href="{% url 'panel_cita_editar' cita.n_cita %}" class="btn btn-sm btn-primary mb-1">Editar</a>
            {% endif %}
            {% if perms.paneltrabajador.delete_cita %}
              <a href="{% url 'panel_cita_eliminar' cita.n_cita %}" class="btn btn-sm btn-danger mb-1">Eliminar</a>
            {% endif %}

            {# --- NUEVOS BOTONES DE ASISTENCIA (solo si ya pasÃ³ la hora y estÃ¡ reservada) --- #}
            {% if perms.paneltrabajador.change_cita and cita.puede_confirmar_asistencia %}
              <form action="{% url 'panel_cita_checkin' cita.n_cita %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-success btn-sm mb-1"
                        {% if cita.asistencia == 'A' %}disabled{% endif %}>
                  âœ… Check-in
                </button>
              </form>

              <form action="{% url 'panel_cita_noasistio' cita.n_cita %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-outline-danger btn-sm mb-1"
                        {% if cita.asistencia == 'N' %}disabled{% endif %}>
                  ðŸš« No asistiÃ³
                </button>
              </form>
            {% endif %}
          </td>
        {% endif %}
      </tr>
    {% empty %}
      <tr>
        <td colspan="9" class="text-center text-muted py-3">
          No hay citas registradas.
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
