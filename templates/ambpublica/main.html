{% extends "./master.html" %}
{% load static %}
{% block title %}
  Arce Vet
{% endblock title %}
{% block content %}

  <style>
    .chatbot-widget {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 1050;
      max-width: 320px;
      width: calc(100% - 3rem);
    }

    .chatbot-panel {
      max-height: 420px;
      display: flex;
      flex-direction: column;
    }

    .chatbot-messages {
      flex: 1 1 auto;
      overflow-y: auto;
      padding: 0.5rem;
      background: #f8f9fa;
      border-radius: 0.5rem;
    }

    .chatbot-bubble {
      display: inline-block;
      padding: 0.4rem 0.6rem;
      border-radius: 0.75rem;
      margin-bottom: 0.5rem;
      max-width: 90%;
      word-break: break-word;
    }

    .chatbot-bubble.bot {
      background: #ffffff;
      border: 1px solid #dee2e6;
    }

    .chatbot-bubble.staff {
      background: #e7f1ff;
      border: 1px solid #cfe2ff;
      color: #052c65;
    }

    .chatbot-bubble.user {
      background: #198754;
      color: #ffffff;
      margin-left: auto;
    }

    /* üîß FIX visual: evita que el bot√≥n "Enviar" desaparezca */
  .chatbot-panel {
    height: 420px; /* reemplaza max-height */
    display: flex;
    flex-direction: column;
  }

  .chatbot-panel .card-body {
    display: flex;
    flex-direction: column;
    gap: .5rem;
    min-height: 0;
    padding: .75rem;
  }

  .chatbot-messages {
    flex: 1 1 auto;
    min-height: 0;
    overflow-y: auto;
    padding: .5rem;
    background: #f8f9fa;
    border-radius: .5rem;
    margin-bottom: 0;
  }

  #chatbot-form {
    display: flex;
    gap: .5rem;
    margin-top: auto;
  }

  #chatbot-input {
    flex: 1 1 auto;
  }

  .chatbot-quick-replies {
    display: flex;
    flex-wrap: wrap;
    gap: .5rem;
  }

  .chatbot-quick-reply {
    border-radius: 999px;
    border: 1px solid transparent;
    background: #e9ecef;
    color: #212529;
    padding: .25rem .85rem;
    font-size: .875rem;
    cursor: pointer;
    transition: background-color .2s ease, color .2s ease;
  }

  .chatbot-quick-reply:hover,
  .chatbot-quick-reply:focus {
    background: #d1e7dd;
    color: #0f5132;
  }

  .service-icon {
    max-width: 80px;
    height: auto;
    margin-bottom: 1rem;
  }

  </style>

  {# Pagina de inicio de Veterinaria de Arce #}
  {# Encabezado #}
  <header class="text-center home text-white hero-carousel">
  <!-- Carrusel de fondo (autoplay) -->
  <div id="heroCarousel" class="carousel slide"
       data-bs-ride="carousel"
       data-bs-interval="4500"
       data-bs-pause="false"
       data-bs-touch="true" aria-hidden="true">
    <div class="carousel-inner">
      <div class="carousel-item active">
        <img src="{% static 'Imagenes/hero-vet.jpg' %}" class="d-block w-100 hero-bg" alt="Portada veterinaria">
      </div>
      <div class="carousel-item">
        <img src="{% static 'Imagenes/gallery-1.jpg' %}" class="d-block w-100 hero-bg" alt="Revisi√≥n de mascota">
      </div>
      <div class="carousel-item">
        <img src="{% static 'Imagenes/gallery-2.jpg' %}" class="d-block w-100 hero-bg" alt="Perro feliz">
      </div>
      <div class="carousel-item">
        <img src="{% static 'Imagenes/gallery-3.jpg' %}" class="d-block w-100 hero-bg" alt="Gato cari√±oso">
      </div>
      <div class="carousel-item">
        <img src="{% static 'Imagenes/gallery-4.jpg' %}" class="d-block w-100 hero-bg" alt="Due√±os y veterinarios">
      </div>
    </div>
  </div>

  <!-- Overlay para que el logo y textos siempre se lean -->
  <div class="hero-overlay"></div>

  <!-- Contenido encima del carrusel -->
  <div class="container hero-content">
    <div class="logo-container mb-2">
      <img src="{% static 'Imagenes/Logo.png' %}" alt="Logo FiCats" class="logo hero-logo" style="max-width: 200px; height: auto;">
    </div>
    <h1 class="text-light display-6 fw-bold mb-2">Veterinaria de Arce</h1>
    <p class="lead mb-0">Cuidando la salud y felicidad de tus mascotas</p>
  </div>
</header>
  {# Nuestros Servicios #}
  <section id="servicios" class="py-5">
    <div class="container">
      <h2 class="text-center">Nuestros Servicios</h2>
      <hr class="w-25 mx-auto" />
      <div class="row">
        <div class="col-12 col-md-4 mb-3">
          <article class="service-card text-center">
            <img src="{% static 'Imagenes/service-consulta.jpg' %}" alt="Consulta general para mascotas" class="service-icon">
            <h3>Consulta General</h3>
            <p>Ex√°menes de rutina, vacunas y atenci√≥n m√©dica general para mascotas.</p>
          </article>
        </div>
        <div class="col-12 col-md-4 mb-3">
          <article class="service-card text-center">
            <img src="{% static 'Imagenes/service-cirugia.jpg' %}" alt="Cirug√≠as veterinarias" class="service-icon">
            <h3>Cirug√≠a</h3>
            <p>Realizamos cirug√≠as con est√°ndares m√©dicos de alta calidad.</p>
          </article>
        </div>
        <div class="col-12 col-md-4 mb-3">
          <article class="service-card text-center">
            <img src="{% static 'Imagenes/service-dentista.jpg' %}" alt="Odontolog√≠a veterinaria" class="service-icon">
            <h3>Dentista</h3>
            <p>Cuidado dental especializado para mascotas.</p>
          </article>
        </div>
      </div>
    </div>
  </section>
  {# Reserva de Horas Online #}
  <section id="reserva" class="py-5">
    <div class="container">
      <h2 class="text-center">Reserva de Horas Online</h2>
      <p class="text-center">Ahorra tiempo y agenda la atenci√≥n que necesita tu mascota con solo unos clics.</p>
      <div class="text-center">
        <a href="{% url 'ambpublico_reserva' %}" class="btn btn-primary btn-lg">Reservar Ahora</a>
      </div>
    </div>
  </section>
  {# Revisi√≥n de Ficha Cl√≠nica Online #}
  <section id="ficha-clinica" class="py-5">
    <div class="container">
      <h2 class="text-center">Revisi√≥n de Ficha Cl√≠nica Online</h2>
      <p class="text-center">Accede a la historia m√©dica de tu mascota desde la comodidad de tu hogar.</p>
      <div class="text-center">
        <a href="{% url 'ambpublico_consulta' %}" class="btn btn-info btn-lg">Ver Detalles</a>
      </div>
    </div>
  </section>
  {# Opiniones de Nuestros Clientes #}
  <section id="opiniones" class="py-5 bg-light autumn-decor">
    <div class="container">
      <h2 class="text-center">Opiniones de Nuestros Clientes</h2>
      <div class="row">
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <p class="card-text">"Mi gata Josefa Faraona recibi√≥ un excelente cuidado aqu√≠. ¬°Realmente se peinan!" - Cesar Arce</p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <p class="card-text">
                "El equipo de Arce tienen los chakras muy alineados. Realmente se preocupan por nuestros amigos peludos." - Robinson Contreras
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card">
            <div class="card-body">
              <p class="card-text">"¬°Servicio profesional y amigable! Mi perico siempre est√° en buenas manos." - Danilo Jose Arias</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
  {# Cont√°ctanos #}
  <section id="contacto" class="py-5">
    <div class="container">
      <h2 class="text-center">Cont√°ctanos</h2>
      <p class="text-center">
        Estamos aqu√≠ para ayudarte. Si tienes alguna pregunta o necesitas m√°s informaci√≥n, no dudes en ponerte en contacto con nosotros. igualmente puede visitarnos personalmente en nuestra clinica
      </p>
      <div class="row">
        <!-- mapa -->
        <div class="col-lg-6 mb-4">
          <div class="ratio ratio-16x9">
            <iframe
              src="https://www.google.com/maps?q=-33.4489,-70.6693&z=16&hl=es&output=embed"
              loading="lazy"
              allowfullscreen
              style="border:0;">
            </iframe>
          </div>
        </div>

        <!--formulario -->
        <div class="col-lg-6">
          <form id="form-contacto" method="post" action="#contacto">
            {% csrf_token %}

            {% if contact_success %}
              <div class="alert alert-success" role="alert">
                ¬°Gracias por contactarnos! Tu mensaje fue enviado correctamente y te responderemos a la brevedad.
              </div>
            {% elif contact_error %}
              <div class="alert alert-danger" role="alert">
                {{ contact_error }}
              </div>
            {% endif %}

            {% if contact_form.errors %}
              <div class="alert alert-danger" role="alert">
                <p class="mb-1">Revisa los datos ingresados:</p>
                <ul class="mb-0">
                  {% for field in contact_form %}
                    {% for error in field.errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                  {% for error in contact_form.non_field_errors %}
                    <li>{{ error }}</li>
                  {% endfor %}
                </ul>
              </div>
            {% endif %}
            <div class="mb-3">
              <label for="{{ contact_form.nombre.id_for_label }}" class="form-label">Nombre</label>
              {{ contact_form.nombre }}
              {% for error in contact_form.nombre.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="mb-3">
              <label for="{{ contact_form.correo.id_for_label }}" class="form-label">Correo Electr√≥nico</label>
              {{ contact_form.correo }}
              {% for error in contact_form.correo.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="mb-3">
              <label for="{{ contact_form.mensaje.id_for_label }}" class="form-label">Mensaje</label>
              {{ contact_form.mensaje }}
              {% for error in contact_form.mensaje.errors %}
                <div class="text-danger small">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="text-center">
              <button type="submit" class="btn btn-primary">Enviar Mensaje</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </section>
  {# Todavia no estar√° listo el formulario contacto #}
  <div id="chatbot-widget" class="chatbot-widget" data-conversation="{{ chatbot_conversation_id|default:'' }}">
    <div class="chatbot-avatar text-center mb-1">
      <img src="{% static 'Imagenes/chatdog.png' %}" alt="Asistente Arce" class="chatbot-dog">
    </div>
    <button id="chatbot-toggle" class="btn btn-success w-100 mb-2" type="button">
      üí¨ Asistente virtual
    </button>
    <div class="card shadow chatbot-panel d-none">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Asistente Arce</span>
        <button type="button" class="btn-close" aria-label="Cerrar" id="chatbot-close"></button>
      </div>
      <div class="card-body d-flex flex-column">
        <div id="chatbot-messages" class="chatbot-messages mb-2">
          <div class="chatbot-bubble bot">
            ¬°Hola! Soy el asistente virtual de la Veterinaria de Arce. Preg√∫ntame por horarios, reservas o pagos.
          </div>
        </div>
        <div id="chatbot-quick-replies" class="chatbot-quick-replies d-none" aria-live="polite"></div>
        <form id="chatbot-form" class="d-flex gap-2" autocomplete="off">
          <input type="text" class="form-control" id="chatbot-input" placeholder="Escribe tu pregunta..." required />
          <button class="btn btn-success" type="submit">Enviar</button>
        </form>
        <small id="chatbot-handoff" class="text-muted mt-2 d-none">
          Hemos avisado a recepci√≥n. Mant√©n el chat abierto y te responder√°n a la brevedad.
        </small>
      </div>
    </div>
  </div>
  <script>
(function () {
  "use strict";


  // --- CHATBOT WIDGET ---
  const widget = document.getElementById("chatbot-widget");
  if (!widget) return;

  const toggleButton  = document.getElementById("chatbot-toggle");
  const closeButton   = document.getElementById("chatbot-close");
  const panel         = widget.querySelector(".chatbot-panel");
  const messageList   = document.getElementById("chatbot-messages");
  const form          = document.getElementById("chatbot-form");
  const input         = document.getElementById("chatbot-input");
  const handoffNotice = document.getElementById("chatbot-handoff");
  const quickReplies  = document.getElementById("chatbot-quick-replies");
  const pollUrl       = "{% url 'ambpublico_chatbot_messages' %}";

  const existingConversation = widget.dataset.conversation;
  let conversationId = existingConversation ? parseInt(existingConversation, 10) : null;
  if (Number.isNaN(conversationId)) {
    conversationId = null;
  }
  let pollTimer = null;
  let lastMessageId = null;

  const togglePanel = (show) => {
    const shouldShow = typeof show === "boolean" ? show : panel.classList.contains("d-none");
    panel.classList.toggle("d-none", !shouldShow);
    if (shouldShow) input.focus();
  };

  const getCookie = (name) => {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
    return null;
  };

  const appendMessage = (text, author, prefix) => {
    const bubble = document.createElement("div");
    bubble.className = `chatbot-bubble ${author}`;
    bubble.textContent = prefix ? `${prefix}: ${text}` : text;
    messageList.appendChild(bubble);
    messageList.scrollTop = messageList.scrollHeight;
  };

  const clearQuickReplies = () => {
    if (!quickReplies) return;
    quickReplies.innerHTML = "";
    quickReplies.classList.add("d-none");
  };

  const showConfirmationOptions = () => {
    if (!quickReplies) return;
    quickReplies.innerHTML = "";

    const yesOption = document.createElement("button");
    yesOption.type = "button";
    yesOption.className = "chatbot-quick-reply";
    yesOption.textContent = "S√≠, hablar con recepci√≥n";
    yesOption.addEventListener("click", () => {
      clearQuickReplies();
      submitMessage("S√≠ quiero hablar con la recepci√≥n");
    });

    const noOption = document.createElement("button");
    noOption.type = "button";
    noOption.className = "chatbot-quick-reply";
    noOption.textContent = "No, gracias";
    noOption.addEventListener("click", () => {
      clearQuickReplies();
      submitMessage("No, gracias");
    });

    quickReplies.appendChild(yesOption);
    quickReplies.appendChild(noOption);
    quickReplies.classList.remove("d-none");
  };

  const handleError = () => {
    clearQuickReplies();
    appendMessage("No pude conectar con el asistente en este momento. Intenta nuevamente m√°s tarde.", "bot");
  };

  const stopPolling = () => {
    if (pollTimer) {
      window.clearTimeout(pollTimer);
      pollTimer = null;
    }
  };

  const schedulePoll = (delay = 4000) => {
    stopPolling();
    pollTimer = window.setTimeout(() => {
      pollTimer = null;
      pollConversation();
    }, delay);
  };

  async function pollConversation() {
    if (!conversationId) {
      return;
    }

    const isInitialLoad = lastMessageId === null;

    try {
      let url = pollUrl;
      if (!isInitialLoad && lastMessageId !== null) {
        url = `${pollUrl}?after=${encodeURIComponent(lastMessageId)}`;
      }

      const response = await fetch(url, {
        headers: { "Accept": "application/json" },
        credentials: "same-origin",
      });

      if (!response.ok) {
        throw new Error("Network error");
      }

      const data = await response.json();

      if (!conversationId && data.conversation_id) {
        const parsedId = parseInt(data.conversation_id, 10);
        conversationId = Number.isNaN(parsedId) ? null : parsedId;
      }

      if (Array.isArray(data.messages) && data.messages.length) {
        if (isInitialLoad) {
          messageList.innerHTML = "";
        }

        data.messages.forEach((message) => {
          const messageId = typeof message.id === "number" ? message.id : null;
          if (messageId !== null && (lastMessageId === null || messageId > lastMessageId)) {
            lastMessageId = messageId;
          }

          if (message.author === "client") {
            if (isInitialLoad) {
              appendMessage(message.content, "user");
            }
            return;
          }

          if (message.author === "staff") {
            appendMessage(message.content, "staff", message.staff_user || "Recepci√≥n");
            return;
          }

          appendMessage(message.content, "bot");
        });
      } else if (typeof data.last_id === "number" && (lastMessageId === null || data.last_id > lastMessageId)) {
        lastMessageId = data.last_id;
      }

      if (data.state === "closed") {
        appendMessage("La conversaci√≥n se cerr√≥. Gracias por escribirnos.", "bot");
        handoffNotice.classList.add("d-none");
        conversationId = null;
        stopPolling();
        return;
      }

      if (conversationId) {
        handoffNotice.classList.remove("d-none");
      }
    } catch (err) {
      console.error("Error actualizando el chat", err);
    } finally {
      if (conversationId) {
        schedulePoll();
      }
    }
  }

  const startPolling = (immediate = false) => {
    if (!conversationId) {
      return;
    }

    if (immediate) {
      stopPolling();
      pollConversation();
    } else {
      schedulePoll();
    }
  };

  toggleButton.addEventListener("click", () => togglePanel());
  closeButton.addEventListener("click", () => togglePanel(false));

  if (conversationId) {
    handoffNotice.classList.remove("d-none");
    startPolling(true);
  }

  const submitMessage = async (message) => {
    appendMessage(message, "user");
    handoffNotice.classList.add("d-none");

    try {
      const response = await fetch("{% url 'ambpublico_chatbot_message' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "X-CSRFToken": getCookie("csrftoken"),
        },
        body: JSON.stringify({ message }),
        credentials: "same-origin",
      });

      if (!response.ok) return handleError();

      const data = await response.json();
      if (data.error) {
        appendMessage(data.error, "bot");
        return;
      }

      if (data.reply) {
        appendMessage(data.reply, "bot");
      }

      if (typeof data.last_message_id === "number") {
        lastMessageId = data.last_message_id;
      }

      if (data.handoff) {
        conversationId = data.conversation_id || conversationId;
        handoffNotice.classList.remove("d-none");
        startPolling(true);
      } else if (!data.pending_confirmation) {
        handoffNotice.classList.add("d-none");
      }

      if (data.pending_confirmation) {
        showConfirmationOptions();
      } else {
        clearQuickReplies();
      }
    } catch (err) {
      handleError();
    }
  };

  form.addEventListener("submit", (event) => {
    event.preventDefault();
    const message = input.value.trim();
    if (!message) return;

    input.value = "";
    clearQuickReplies();
    submitMessage(message);
  });

})(); 