{% extends "./master.html" %}
{% load static %}
{% block title %}
  Arce Vet
{% endblock title %}
{% block content %}

  <style>
    .chatbot-widget {
      position: fixed;
      bottom: 1.5rem;
      right: 1.5rem;
      z-index: 1050;
      max-width: 360px;
      width: calc(100% - 3rem);
    }

    .chatbot-panel {
      height: 520px;
      display: flex;
      flex-direction: column;
      font-size: 1rem;
    }

    .chatbot-panel .card-body {
      display: flex;
      flex-direction: column;
      gap: .5rem;
      min-height: 0;
      padding: .75rem;
    }

    .chatbot-messages {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
      padding: .5rem;
      background: #f8f9fa;
      border-radius: .5rem;
      margin-bottom: 0;
      display: flex;
      flex-direction: column;
      gap: .75rem;
    }

    .chatbot-bubble {
      display: flex;
      gap: .75rem;
      align-items: flex-start;
    }

    .chatbot-bubble.user {
      flex-direction: row-reverse;
    }

    .chatbot-avatar-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: #495057;
      flex-shrink: 0;
    }

    .chatbot-bubble.bot .chatbot-avatar-circle {
      background: #e7f1ff;
      color: #0b5ed7;
    }

    .chatbot-bubble.user .chatbot-avatar-circle {
      background: #198754;
      color: #fff;
    }

    .chatbot-bubble.staff .chatbot-avatar-circle {
      background: #d1e7ff;
      color: #052c65;
    }

    .chatbot-content {
      background: #fff;
      border: 1px solid #dee2e6;
      border-radius: .85rem;
      padding: .65rem .9rem;
      max-width: 240px;
      word-break: break-word;
    }

    .chatbot-bubble.user .chatbot-content {
      background: #198754;
      color: #fff;
      border-color: #146c43;
    }

    .chatbot-meta {
      display: flex;
      justify-content: space-between;
      font-size: .85rem;
      font-weight: 600;
      margin-bottom: .25rem;
      text-transform: capitalize;
    }

    .chatbot-meta span {
      color: inherit;
      opacity: .8;
    }

    .chatbot-bubble.user .chatbot-meta {
      flex-direction: row-reverse;
    }

    .chatbot-text {
      font-size: 1rem;
      line-height: 1.45;
    }

    #chatbot-form {
      display: flex;
      gap: .5rem;
      margin-top: auto;
    }

    #chatbot-input {
      flex: 1 1 auto;
    }

    .chatbot-quick-replies {
      display: flex;
      flex-wrap: wrap;
      gap: .5rem;
    }

    .chatbot-quick-reply {
      border-radius: 999px;
      border: 1px solid transparent;
      background: #e9ecef;
      color: #212529;
      padding: .25rem .85rem;
      font-size: .95rem;
      cursor: pointer;
      transition: background-color .2s ease, color .2s ease;
    }

    .chatbot-quick-reply:hover,
    .chatbot-quick-reply:focus {
      background: #d1e7dd;
      color: #0f5132;
    }

    .chatbot-typing {
      display: flex;
      align-items: center;
      gap: .4rem;
      font-size: .95rem;
      color: #0b5ed7;
    }

    .chatbot-typing .dot {
      width: 6px;
      height: 6px;
      background: currentColor;
      border-radius: 50%;
      animation: chatbotBlink 1s infinite ease-in-out;
    }

    .chatbot-typing .dot:nth-child(2) {
      animation-delay: .15s;
    }

    .chatbot-typing .dot:nth-child(3) {
      animation-delay: .3s;
    }

    @keyframes chatbotBlink {
      0%, 80%, 100% { opacity: .2; }
      40% { opacity: 1; }
    }
  </style>

  {# Pagina de inicio de Veterinaria de Arce #}
  {# Encabezado #}
  <header class="text-center home text-white hero-carousel">
    <!-- Carrusel de fondo (autoplay) -->
    <div id="heroCarousel" class="carousel slide"
         data-bs-ride="carousel"
         data-bs-interval="4500"
         data-bs-pause="false"
         data-bs-touch="true" aria-hidden="true">
      <div class="carousel-inner">
        <div class="carousel-item active">
          <img src="{% static 'Imagenes/hero-vet.jpg' %}" class="d-block w-100 hero-bg" alt="Portada veterinaria">
        </div>
        <div class="carousel-item">
          <img src="{% static 'Imagenes/gallery-1.jpg' %}" class="d-block w-100 hero-bg" alt="Revisi√≥n de mascota">
        </div>
        <div class="carousel-item">
          <img src="{% static 'Imagenes/gallery-2.jpg' %}" class="d-block w-100 hero-bg" alt="Perro feliz">
        </div>
        <div class="carousel-item">
          <img src="{% static 'Imagenes/gallery-3.jpg' %}" class="d-block w-100 hero-bg" alt="Gato cari√±oso">
        </div>
        <div class="carousel-item">
          <img src="{% static 'Imagenes/gallery-4.jpg' %}" class="d-block w-100 hero-bg" alt="Due√±os y veterinarios">
        </div>
      </div>
    </div>

    <!-- Overlay para que el logo y textos siempre se lean -->
    <div class="hero-overlay"></div>

    <!-- Contenido encima del carrusel -->
    <div class="container hero-content">
      <div class="logo-container mb-2">
        <img src="{% static 'Imagenes/Logo.png' %}" alt="Logo FiCats" class="logo hero-logo">
      </div>
      <h1 class="text-light display-6 fw-bold mb-2">Veterinaria de Arce</h1>
      <p class="lead mb-0">Cuidando la salud y felicidad de tus mascotas</p>
    </div>
  </header>

  {# Nuestros Servicios #}
  <section id="servicios" class="py-5">
    <div class="container">
      <h2 class="text-center">Nuestros Servicios</h2>
      <hr class="w-25 mx-auto" />
      <div class="row">
        <div class="col-12 col-md-4 mb-3">
          <article class="service-card text-center position-relative h-100">
            <img src="{% static 'Imagenes/service-consulta.jpg' %}" alt="Consulta general para mascotas" class="service-icon">
            <h3>Consulta General</h3>
            <p>Ex√°menes de rutina, vacunas y atenci√≥n m√©dica general para mascotas.</p>
            <a class="stretched-link" href="{% url 'ambpublico_servicio_detalle' 'consulta-general' %}">
              <span class="visually-hidden">Ver m√°s sobre consulta general</span>
            </a>
          </article>
        </div>
        <div class="col-12 col-md-4 mb-3">
          <article class="service-card text-center position-relative h-100">
            <img src="{% static 'Imagenes/service-cirugia.jpg' %}" alt="Cirug√≠as veterinarias" class="service-icon">
            <h3>Cirug√≠a</h3>
            <p>Realizamos cirug√≠as con est√°ndares m√©dicos de alta calidad.</p>
            <a class="stretched-link" href="{% url 'ambpublico_servicio_detalle' 'cirugia' %}">
              <span class="visually-hidden">Ver m√°s sobre cirug√≠as veterinarias</span>
            </a>
          </article>
        </div>
        <div class="col-12 col-md-4 mb-3">
          <article class="service-card text-center position-relative h-100">
            <img src="{% static 'Imagenes/service-dentista.jpg' %}" alt="Odontolog√≠a veterinaria" class="service-icon">
            <h3>Dentista</h3>
            <p>Cuidado dental especializado para mascotas.</p>
            <a class="stretched-link" href="{% url 'ambpublico_servicio_detalle' 'dentista' %}">
              <span class="visually-hidden">Ver m√°s sobre odontolog√≠a veterinaria</span>
            </a>
          </article>
        </div>
      </div>
    </div>
  </section>

  {# Reserva de Horas Online #}
  <section id="reserva" class="py-5">
    <div class="container">
      <h2 class="text-center">Reserva de Horas Online</h2>
      <p class="text-center">Ahorra tiempo y agenda la atenci√≥n que necesita tu mascota con solo unos clics.</p>
      <div class="text-center">
        <a href="{% url 'ambpublico_reserva' %}" class="btn btn-primary btn-lg">Reservar Ahora</a>
      </div>
    </div>
  </section>

  {# Revisi√≥n de Ficha Cl√≠nica Online #}
  <section id="ficha-clinica" class="py-5">
    <div class="container">
      <h2 class="text-center">Revisi√≥n de Ficha Cl√≠nica Online</h2>
      <p class="text-center">Accede a la historia m√©dica de tu mascota desde la comodidad de tu hogar.</p>
      <div class="text-center">
        <a href="{% url 'ambpublico_consulta' %}" class="btn btn-info btn-lg">Ver Detalles</a>
      </div>
    </div>
  </section>

  {# Opiniones de Nuestros Clientes #}
  <section id="opiniones" class="py-5 bg-maple-soft autumn-decor">
    <div class="container testimonials-wrap">
      <h2 class="text-center mb-4">Opiniones de Nuestros Clientes</h2>
      <div class="testimonials-slider" data-active-index="0">
        <button class="testimonial-nav prev" type="button" aria-label="Opini√≥n anterior">
          <i class="bi bi-chevron-left"></i>
        </button>

        <div class="testimonials-viewport">
          <div class="testimonials-track">
            <article class="card testimonial-card testimonial-slide h-100">
              <div class="card-body d-flex flex-column">
                <p class="card-text flex-grow-1">
                  "Mi gata Josefa Faraona recibi√≥ un excelente cuidado aqu√≠. ¬°Realmente se peinan!"
                </p>
                <div class="testimonial-meta">
                  <div>
                    <strong class="d-block">Cesar Arce</strong>
                    <small class="text-muted">Control preventivo felino</small>
                  </div>
                  <div class="testimonial-stars" aria-label="5 de 5 estrellas">
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                  </div>
                </div>
              </div>
            </article>

            <article class="card testimonial-card testimonial-slide h-100">
              <div class="card-body d-flex flex-column">
                <p class="card-text flex-grow-1">
                  "El equipo de Arce tiene los chakras muy alineados. Realmente se preocupan por nuestros amigos peludos."
                </p>
                <div class="testimonial-meta">
                  <div>
                    <strong class="d-block">Robinson Contreras</strong>
                    <small class="text-muted">Urgencia para Bruno</small>
                  </div>
                  <div class="testimonial-stars" aria-label="5 de 5 estrellas">
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                  </div>
                </div>
              </div>
            </article>

            <article class="card testimonial-card testimonial-slide h-100">
              <div class="card-body d-flex flex-column">
                <p class="card-text flex-grow-1">
                  "¬°Servicio profesional y amigable! Mi perico siempre est√° en buenas manos."
                </p>
                <div class="testimonial-meta">
                  <div>
                    <strong class="d-block">Danilo Jose Arias</strong>
                    <small class="text-muted">Rehabilitaci√≥n de Coco</small>
                  </div>
                  <div class="testimonial-stars" aria-label="4.5 de 5 estrellas">
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-half"></i>
                  </div>
                </div>
              </div>
            </article>

            <article class="card testimonial-card testimonial-slide h-100">
              <div class="card-body d-flex flex-column">
                <p class="card-text flex-grow-1">
                  "Nos ayudaron a entender el tratamiento cr√≥nico de nuestro viejito bigotes y ahora est√° m√°s activo que nunca."
                </p>
                <div class="testimonial-meta">
                  <div>
                    <strong class="d-block">Mar√≠a Fernanda Mu√±oz</strong>
                    <small class="text-muted">Plan senior para Bigotes</small>
                  </div>
                  <div class="testimonial-stars" aria-label="5 de 5 estrellas">
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                  </div>
                </div>
              </div>
            </article>

            <article class="card testimonial-card testimonial-slide h-100">
              <div class="card-body d-flex flex-column">
                <p class="card-text flex-grow-1">
                  "El seguimiento online de la ficha cl√≠nica es comod√≠simo. Me recuerdan las vacunas y controlan la evoluci√≥n."
                </p>
                <div class="testimonial-meta">
                  <div>
                    <strong class="d-block">Javier Pardo</strong>
                    <small class="text-muted">Tutor de Loba y Milo</small>
                  </div>
                  <div class="testimonial-stars" aria-label="4 de 5 estrellas">
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star"></i>
                  </div>
                </div>
              </div>
            </article>

            <article class="card testimonial-card testimonial-slide h-100">
              <div class="card-body d-flex flex-column">
                <p class="card-text flex-grow-1">
                  "A Luna la operaron con un cari√±o tremendo y las indicaciones post operatorias fueron muy claras."
                </p>
                <div class="testimonial-meta">
                  <div>
                    <strong class="d-block">Paula Sep√∫lveda</strong>
                    <small class="text-muted">Cirug√≠a de Luna</small>
                  </div>
                  <div class="testimonial-stars" aria-label="4.5 de 5 estrellas">
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-fill"></i>
                    <i class="bi bi-star-half"></i>
                  </div>
                </div>
              </div>
            </article>
          </div>
        </div>
        <button class="testimonial-nav next" type="button" aria-label="Opini√≥n siguiente">
          <i class="bi bi-chevron-right"></i>
        </button>
      </div>
    </div>
  </section>

  {# Cont√°ctanos #}
  <section id="contacto" class="py-5 bg-maple-cream">
    <div class="container">
      <h2 class="text-center mb-3">Cont√°ctanos</h2>
      <p class="text-center mb-4">
        Estamos aqu√≠ para ayudarte. Si tienes alguna pregunta o necesitas m√°s informaci√≥n, no dudes en ponerte en contacto con nosotros.
        Igualmente puedes visitarnos personalmente en nuestra cl√≠nica.
      </p>
      <div class="row g-4">
        <!-- mapa -->
        <div class="col-lg-6">
          <div class="ratio maple-map">
            <iframe
              src="https://www.google.com/maps?q=-33.4489,-70.6693&z=16&hl=es&output=embed"
              loading="lazy"
              allowfullscreen
              style="border:0;">
            </iframe>
          </div>
        </div>

        <!--formulario -->
        <div class="col-lg-6">
          <div class="maple-form-card maple-form h-100">
            <form id="form-contacto" method="post" action="#contacto">
              {% csrf_token %}

              {% if contact_success %}
                <div class="alert alert-success" role="alert">
                  ¬°Gracias por contactarnos! Tu mensaje fue enviado correctamente y te responderemos a la brevedad.
                </div>
              {% elif contact_error %}
                <div class="alert alert-danger" role="alert">
                  {{ contact_error }}
                </div>
              {% endif %}

              {% if contact_form.errors %}
                <div class="alert alert-danger" role="alert">
                  <p class="mb-1">Revisa los datos ingresados:</p>
                  <ul class="mb-0">
                    {% for field in contact_form %}
                      {% for error in field.errors %}
                        <li>{{ error }}</li>
                      {% endfor %}
                    {% endfor %}
                    {% for error in contact_form.non_field_errors %}
                      <li>{{ error }}</li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}

              <div class="mb-3">
                <label for="{{ contact_form.nombre.id_for_label }}" class="form-label">Nombre</label>
                {{ contact_form.nombre }}
                {% for error in contact_form.nombre.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="mb-3">
                <label for="{{ contact_form.correo.id_for_label }}" class="form-label">Correo Electr√≥nico</label>
                {{ contact_form.correo }}
                {% for error in contact_form.correo.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="mb-3">
                <label for="{{ contact_form.mensaje.id_for_label }}" class="form-label">Mensaje</label>
                {{ contact_form.mensaje }}
                {% for error in contact_form.mensaje.errors %}
                  <div class="text-danger small">{{ error }}</div>
                {% endfor %}
              </div>
              <div class="text-center">
                <button type="submit" class="btn btn-maple-green px-4">Enviar Mensaje</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const slider = document.querySelector(".testimonials-slider");
      if (!slider) return;

      const track = slider.querySelector(".testimonials-track");
      const cards = Array.from(track.children);
      const prevBtn = slider.querySelector(".testimonial-nav.prev");
      const nextBtn = slider.querySelector(".testimonial-nav.next");

      const getCardsPerView = () => {
        if (window.innerWidth < 768) return 1;
        if (window.innerWidth < 1200) return 2;
        return 3;
      };

      let cardsPerView = getCardsPerView();
      let currentIndex = 0;

      const clampIndex = (index) => {
        const maxIndex = Math.max(0, cards.length - cardsPerView);
        return Math.min(Math.max(index, 0), maxIndex);
      };

      const updateButtons = () => {
        if (prevBtn) {
          prevBtn.disabled = currentIndex === 0;
        }
        if (nextBtn) {
          nextBtn.disabled = currentIndex >= cards.length - cardsPerView;
        }
      };

      const animateToIndex = () => {
        const targetCard = cards[currentIndex];
        if (!targetCard) return;
        const offset = targetCard.offsetLeft;
        track.style.transform = `translateX(-${offset}px)`;
        slider.setAttribute("data-active-index", currentIndex);
        updateButtons();
      };

      const handleResize = () => {
        const newCardsPerView = getCardsPerView();
        if (newCardsPerView !== cardsPerView) {
          cardsPerView = newCardsPerView;
          currentIndex = clampIndex(currentIndex);
        }
        window.requestAnimationFrame(animateToIndex);
      };

      prevBtn?.addEventListener("click", () => {
        currentIndex = clampIndex(currentIndex - cardsPerView);
        animateToIndex();
      });

      nextBtn?.addEventListener("click", () => {
        currentIndex = clampIndex(currentIndex + cardsPerView);
        animateToIndex();
      });

      window.addEventListener("resize", handleResize);
      animateToIndex();
    });
  </script>

  {# Chatbot #}
  <div id="chatbot-widget" class="chatbot-widget" data-conversation="{{ chatbot_conversation_id|default:'' }}">
    <div class="chatbot-avatar text-center mb-1">
      <img src="{% static 'Imagenes/chatdog.png' %}" alt="Asistente Arce" class="chatbot-dog">
    </div>
    <button id="chatbot-toggle" class="btn btn-success w-100 mb-2" type="button">
      üí¨ Asistente virtual
    </button>
    <div class="card shadow chatbot-panel d-none">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span>Asistente Arce</span>
        <button type="button" class="btn-close" aria-label="Cerrar" id="chatbot-close"></button>
      </div>
      <div class="card-body d-flex flex-column">
        <div id="chatbot-messages" class="chatbot-messages mb-2"></div>
        <div id="chatbot-typing" class="chatbot-typing d-none" aria-live="polite">
          <span class="dot" aria-hidden="true"></span>
          <span class="dot" aria-hidden="true"></span>
          <span class="dot" aria-hidden="true"></span>
          <span>Asistente escribiendo‚Ä¶</span>
        </div>
        <div id="chatbot-quick-replies" class="chatbot-quick-replies d-none" aria-live="polite"></div>
        <form id="chatbot-form" class="d-flex gap-2" autocomplete="off">
          <input type="text" class="form-control" id="chatbot-input" placeholder="Escribe tu pregunta..." required />
          <button class="btn btn-success" type="submit">Enviar</button>
        </form>
        <small id="chatbot-handoff" class="text-muted mt-2 d-none">
          Hemos avisado a recepci√≥n. Mant√©n el chat abierto y te responder√°n a la brevedad.
        </small>
      </div>
    </div>
  </div>

  <script>
  (function () {
    "use strict";

    // --- CHATBOT WIDGET ---
    const widget = document.getElementById("chatbot-widget");
    if (!widget) return;

    const toggleButton  = document.getElementById("chatbot-toggle");
    const closeButton   = document.getElementById("chatbot-close");
    const panel         = widget.querySelector(".chatbot-panel");
    const messageList   = document.getElementById("chatbot-messages");
    const form          = document.getElementById("chatbot-form");
    const input         = document.getElementById("chatbot-input");
    const handoffNotice = document.getElementById("chatbot-handoff");
    const quickReplies  = document.getElementById("chatbot-quick-replies");
    const typingIndicator = document.getElementById("chatbot-typing");
    const pollUrl       = "{% url 'ambpublico_chatbot_messages' %}";
    const BOT_NAME = "Asistente Arce";
    const USER_NAME = "T√∫";
    const STAFF_FALLBACK_NAME = "Recepci√≥n";
    const INITIAL_GREETING = "¬°Hola! Soy el asistente virtual de la Veterinaria de Arce. Preg√∫ntame por horarios, servicios o tus reservas.";

    const existingConversation = widget.dataset.conversation;
    let conversationId = existingConversation ? parseInt(existingConversation, 10) : null;
    if (Number.isNaN(conversationId)) {
      conversationId = null;
    }
    let pollTimer = null;
    let lastMessageId = null;

    const togglePanel = (show) => {
      const shouldShow = typeof show === "boolean" ? show : panel.classList.contains("d-none");
      panel.classList.toggle("d-none", !shouldShow);
      if (shouldShow) input.focus();
    };

    const getCookie = (name) => {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(";").shift();
      return null;
    };

    const formatTimestamp = (timestamp) => {
      if (!timestamp) {
        return new Date().toLocaleTimeString("es-CL", { hour: "2-digit", minute: "2-digit" });
      }
      try {
        return new Date(timestamp).toLocaleTimeString("es-CL", { hour: "2-digit", minute: "2-digit" });
      } catch (e) {
        return new Date().toLocaleTimeString("es-CL", { hour: "2-digit", minute: "2-digit" });
      }
    };

    const getDisplayName = (author, meta = {}) => {
      if (author === "user") return USER_NAME;
      if (author === "staff") return meta.displayName || meta.staffUser || STAFF_FALLBACK_NAME;
      return meta.displayName || BOT_NAME;
    };

    const getAvatarLabel = (author, name) => {
      if (author === "bot") return "ü§ñ";
      if (!name) return "‚Ä¢";
      return name.charAt(0).toUpperCase();
    };

    const appendMessage = (text, author, meta = {}) => {
      const bubble = document.createElement("div");
      bubble.className = `chatbot-bubble ${author}`;

      const avatar = document.createElement("div");
      avatar.className = "chatbot-avatar-circle";
      const displayName = getDisplayName(author, meta);
      avatar.textContent = getAvatarLabel(author, displayName);

      const content = document.createElement("div");
      content.className = "chatbot-content";

      const metaRow = document.createElement("div");
      metaRow.className = "chatbot-meta";
      const nameSpan = document.createElement("span");
      nameSpan.textContent = displayName;
      const timeSpan = document.createElement("span");
      timeSpan.textContent = formatTimestamp(meta.timestamp);
      metaRow.appendChild(nameSpan);
      metaRow.appendChild(timeSpan);

      const body = document.createElement("div");
      body.className = "chatbot-text";
      body.textContent = text;

      content.appendChild(metaRow);
      content.appendChild(body);
      bubble.appendChild(avatar);
      bubble.appendChild(content);
      messageList.appendChild(bubble);
      messageList.scrollTop = messageList.scrollHeight;
    };

    const clearQuickReplies = () => {
      if (!quickReplies) return;
      quickReplies.innerHTML = "";
      quickReplies.classList.add("d-none");
    };

    const setTyping = (isVisible) => {
      if (!typingIndicator) return;
      typingIndicator.classList.toggle("d-none", !isVisible);
    };

    const showConfirmationOptions = () => {
      if (!quickReplies) return;
      quickReplies.innerHTML = "";

      const yesOption = document.createElement("button");
      yesOption.type = "button";
      yesOption.className = "chatbot-quick-reply";
      yesOption.textContent = "S√≠, hablar con recepci√≥n";
      yesOption.addEventListener("click", () => {
        clearQuickReplies();
        submitMessage("S√≠ quiero hablar con la recepci√≥n");
      });

      const noOption = document.createElement("button");
      noOption.type = "button";
      noOption.className = "chatbot-quick-reply";
      noOption.textContent = "No, gracias";
      noOption.addEventListener("click", () => {
        clearQuickReplies();
        submitMessage("No, gracias");
      });

      quickReplies.appendChild(yesOption);
      quickReplies.appendChild(noOption);
      quickReplies.classList.remove("d-none");
    };

    const handleError = () => {
      clearQuickReplies();
      setTyping(false);
      appendMessage(
        "No pude conectar con el asistente en este momento. Intenta nuevamente m√°s tarde.",
        "bot",
        { displayName: BOT_NAME, timestamp: new Date().toISOString() }
      );
    };

    const stopPolling = () => {
      if (pollTimer) {
        window.clearTimeout(pollTimer);
        pollTimer = null;
      }
    };

    const schedulePoll = (delay = 4000) => {
      stopPolling();
      pollTimer = window.setTimeout(() => {
        pollTimer = null;
        pollConversation();
      }, delay);
    };

    async function pollConversation() {
      if (!conversationId) {
        return;
      }

      const isInitialLoad = lastMessageId === null;

      try {
        let url = pollUrl;
        if (!isInitialLoad && lastMessageId !== null) {
          url = `${pollUrl}?after=${encodeURIComponent(lastMessageId)}`;
        }

        const response = await fetch(url, {
          headers: { "Accept": "application/json" },
          credentials: "same-origin",
        });

        if (!response.ok) {
          throw new Error("Network error");
        }

        const data = await response.json();

        if (!conversationId && data.conversation_id) {
          const parsedId = parseInt(data.conversation_id, 10);
          conversationId = Number.isNaN(parsedId) ? null : parsedId;
        }

        if (Array.isArray(data.messages) && data.messages.length) {
          if (isInitialLoad) {
            messageList.innerHTML = "";
          }

          data.messages.forEach((message) => {
            const messageId = typeof message.id === "number" ? message.id : null;
            if (messageId !== null && (lastMessageId === null || messageId > lastMessageId)) {
              lastMessageId = messageId;
            }

            if (message.author === "client") {
              if (isInitialLoad) {
                appendMessage(message.content, "user", {
                  timestamp: message.created_at,
                  displayName: USER_NAME,
                });
              }
              return;
            }

            if (message.author === "staff") {
              appendMessage(message.content, "staff", {
                displayName: message.staff_user || STAFF_FALLBACK_NAME,
                timestamp: message.created_at,
              });
              return;
            }

            appendMessage(message.content, "bot", {
              displayName: BOT_NAME,
              timestamp: message.created_at,
            });
          });
        } else if (typeof data.last_id === "number" && (lastMessageId === null || data.last_id > lastMessageId)) {
          lastMessageId = data.last_id;
        }

        if (data.state === "closed") {
          appendMessage("La conversaci√≥n se cerr√≥. Gracias por escribirnos.", "bot", {
            displayName: BOT_NAME,
            timestamp: new Date().toISOString(),
          });
          handoffNotice.classList.add("d-none");
          conversationId = null;
          stopPolling();
          return;
        }

        if (conversationId) {
          handoffNotice.classList.remove("d-none");
        }
      } catch (err) {
        console.error("Error actualizando el chat", err);
      } finally {
        if (conversationId) {
          schedulePoll();
        }
      }
    }

    const startPolling = (immediate = false) => {
      if (!conversationId) {
        return;
      }

      if (immediate) {
        stopPolling();
        pollConversation();
      } else {
        schedulePoll();
      }
    };

    toggleButton.addEventListener("click", () => togglePanel());
    closeButton.addEventListener("click", () => togglePanel(false));

    if (conversationId) {
      handoffNotice.classList.remove("d-none");
      startPolling(true);
    } else {
      appendMessage(INITIAL_GREETING, "bot", {
        displayName: BOT_NAME,
        timestamp: new Date().toISOString(),
      });
    }

    const submitMessage = async (message) => {
      appendMessage(message, "user", {
        displayName: USER_NAME,
        timestamp: new Date().toISOString(),
      });
      handoffNotice.classList.add("d-none");
      setTyping(true);

      try {
        const response = await fetch("{% url 'ambpublico_chatbot_message' %}", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": getCookie("csrftoken"),
          },
          body: JSON.stringify({ message }),
          credentials: "same-origin",
        });

        if (!response.ok) return handleError();

        const data = await response.json();
        if (data.error) {
          appendMessage(data.error, "bot", {
            displayName: BOT_NAME,
            timestamp: new Date().toISOString(),
          });
          return;
        }

        if (data.reply) {
          appendMessage(data.reply, "bot", {
            displayName: BOT_NAME,
            timestamp: new Date().toISOString(),
          });
        }

        if (typeof data.last_message_id === "number") {
          lastMessageId = data.last_message_id;
        }

        if (data.handoff) {
          conversationId = data.conversation_id || conversationId;
          handoffNotice.classList.remove("d-none");
          startPolling(true);
        } else if (!data.pending_confirmation) {
          handoffNotice.classList.add("d-none");
        }

        if (data.pending_confirmation) {
          showConfirmationOptions();
        } else {
          clearQuickReplies();
        }
      } catch (err) {
        handleError();
      } finally {
        setTyping(false);
      }
    };

    form.addEventListener("submit", (event) => {
      event.preventDefault();
      const message = input.value.trim();
      if (!message) return;

      input.value = "";
      clearQuickReplies();
      submitMessage(message);
    });

  })();
  </script>
{% endblock content %}
