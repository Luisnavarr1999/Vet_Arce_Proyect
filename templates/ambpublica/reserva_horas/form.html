{% extends "../master.html" %} 
{% block title %}
  Arce Vet - Reserva de horas
{% endblock title %}
{% block content %}

  {% if step == 'final' %}
    <style>
      .booking-calendar {
        background: #f9fafb;
        border: 1px solid #e6e8eb;
        border-radius: 16px;
        padding: 1.25rem;
      }

      .calendar-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 1rem;
      }

      .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, minmax(0, 1fr));
        gap: 0.5rem;
      }

      .calendar-weekday {
        font-size: 0.85rem;
        font-weight: 700;
        text-transform: uppercase;
        color: #8b909a;
      }

      .calendar-day-btn {
        width: 100%;
        border: 1px solid #e6e8eb;
        background: #fff;
        border-radius: 12px;
        padding: 0.75rem 0.5rem;
        text-align: center;
        transition: all 0.2s ease;
        min-height: 3.25rem;
      }

      .calendar-day-btn.available:hover,
      .calendar-day-btn.available:focus {
        transform: translateY(-2px);
        border-color: #f0c15e;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      }

      .calendar-day-btn.available {
        cursor: pointer;
        color: #3b4148;
        font-weight: 600;
      }

      .calendar-day-btn.disabled {
        background: #f0f2f5;
        color: #b0b5bf;
        cursor: not-allowed;
      }

      .calendar-day-btn.selected {
        border-color: #2fb171;
        background: #e8f7ef;
        color: #236b45;
        font-weight: 700;
      }

      .time-slot-btn {
        border-radius: 999px;
        border: 1px solid #dfe3e6;
        background: #fff;
        color: #1f2a36;
        padding: 0.55rem 0.95rem;
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        transition: all 0.15s ease;
      }

      .time-slot-btn .time-label {
        font-weight: 700;
      }

      .time-slot-btn .vet-label {
        color: #66707b;
        font-size: 0.9rem;
      }

      .time-slot-btn:hover,
      .time-slot-btn:focus {
        border-color: #f0c15e;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.07);
      }

      .time-slot-btn.active {
        background: linear-gradient(135deg, #2fb171, #36c581);
        color: #fff;
        border-color: #2fb171;
        box-shadow: 0 10px 18px rgba(47, 177, 113, 0.25);
      }

      .time-slot-btn.active .vet-label {
        color: rgba(255, 255, 255, 0.85);
      }

      .slot-helper {
        color: #77808b;
        font-size: 0.95rem;
      }

      .summary-card {
        border: 1px solid #e6e8eb;
        border-radius: 16px;
        background: #fff7ec;
        padding: 1.25rem;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      }

      .summary-avatar {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        object-fit: cover;
        border: 3px solid #fff;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
      }

      .summary-avatar-fallback {
        width: 72px;
        height: 72px;
        border-radius: 50%;
        background: linear-gradient(135deg, #f0c15e, #f88d3b);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-size: 2rem;
        box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1);
      }

      .summary-meta {
        display: grid;
        grid-template-columns: repeat(1, minmax(0, 1fr));
        gap: 0.6rem;
      }

      .summary-label {
        color: #7a828c;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.2rem;
      }

      .summary-value {
        font-weight: 700;
        color: #1f2a36;
        font-size: 1.05rem;
      }

      @media (min-width: 992px) {
        .summary-card.sticky-lg {
          position: sticky;
          top: 1rem;
        }
      }
    </style>
  {% endif %}

  {# HERO INICIAL (PRIMER PASO O SIN HORAS) #}
  {% if step == '' or step == 'nohours' %}
    <section class="maple-hero-block text-center my-4">
      <div class="maple-hero-badge text-uppercase">
        <i class="bi bi-calendar-heart"></i>
        Agenda
      </div>
      <h1 class="display-5 mt-3">Reserva de horas</h1>
      <hr class="sep-short" />
      <p class="lead">
        Desde la comodidad de tu casa solicita nuestra atención médica en tres pasos.
      </p>
      <p class="mb-0 fs-5">
        Selecciona el servicio, identifica a tu mascota y confirma tu hora.
      </p>

      {% if service_highlights %}
        <div class="row row-cols-1 row-cols-md-3 g-3 mt-4">
          {% for service in service_highlights %}
            <div class="col">
              <div class="maple-highlight-card h-100 text-start">
                <div class="d-flex align-items-center gap-3 mb-3">
                  <span class="rounded-circle d-flex align-items-center justify-content-center bg-white text-warning shadow-sm"
                        style="width: 3.25rem; height: 3.25rem;">
                    <i class="bi {{ service.icon }} fs-4"></i>
                  </span>
                  <h2 class="h5 mb-0 text-uppercase text-muted">{{ service.name }}</h2>
                </div>
                <p class="mb-0 text-secondary">{{ service.description }}</p>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </section>
  {% endif %}

  {# PASOS / WIZARD #}
  {% if progress and step != 'nohours' %}
    <div class="maple-steps mb-4">
      {% for stage in progress %}
        <div class="maple-step {% if stage.is_current %}is-current{% elif stage.is_completed %}is-completed{% endif %}">
          <div class="step-index">{{ forloop.counter }}</div>
          <div>
            <div class="step-label">
              <i class="bi {{ stage.icon }} me-1"></i>{{ stage.label }}
            </div>
            {% if stage.is_completed %}
              <small>Completado</small>
            {% elif stage.is_current %}
              <small>Paso actual</small>
            {% else %}
              <small>Pendiente</small>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# CASO SIN HORAS DISPONIBLES #}
  {% if step == 'nohours' %}
    <div class="maple-info-card shadow-sm mb-3">
      <div class="d-flex flex-column flex-md-row align-items-md-center gap-3">
        <span class="rounded-circle bg-white shadow-sm d-flex align-items-center justify-content-center"
              style="width: 3.5rem; height: 3.5rem;">
          <i class="bi bi-hourglass-split fs-4 text-warning"></i>
        </span>
        <div>
          <h2 class="h5 mb-2">Por ahora no contamos con horas disponibles.</h2>
          <p class="mb-2">
            Actualizamos nuestra agenda con frecuencia. Te invitamos a intentarlo nuevamente más tarde
            o a comunicarte con nuestro equipo para recibir asistencia personalizada.
          </p>
          <p class="mb-0">
            Si ya tienes una hora agendada y necesitas hacer cambios, puedes gestionarla desde la sección
            <strong>Cancelar cita</strong>.
          </p>
        </div>
      </div>
    </div>
    <div class="d-flex flex-column flex-md-row gap-2">
      <a href="{% url 'ambpublico_index' %}" class="btn btn-outline-maple w-100">Volver al inicio</a>
      <a href="{% url 'ambpublico_cancelar_cita' %}" class="btn btn-maple-red w-100">Cancelar cita</a>
    </div>

  {% else %}
    {# OTRAS ESPECIALIDADES CON DISPONIBILIDAD #}
    {% if servicios_alternativos %}
      <div class="maple-info-card shadow-sm mb-4">
        <h2 class="h5 mb-3 d-flex align-items-center gap-2">
          <i class="bi bi-stars text-warning"></i>
          Otras especialidades con disponibilidad
        </h2>
        <div class="row row-cols-1 row-cols-md-3 g-3">
          {% for service in servicios_alternativos %}
            <div class="col">
              <div class="maple-card h-100">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span class="text-warning fs-4"><i class="bi {{ service.icon }}"></i></span>
                  <h3 class="h5 mb-0">{{ service.name }}</h3>
                </div>
                <p class="mb-3 text-muted">{{ service.description }}</p>
                <p class="mb-0 fw-semibold text-secondary">
                  Selecciona este servicio en el primer paso para ver sus horarios disponibles.
                </p>
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {# BANDA "TENEMOS HORAS DISPONIBLES" #}
    {% if step == '' and servicios_disponibles %}
      <div class="maple-availability shadow-sm mb-4">
        <div class="fw-semibold mb-2 d-flex align-items-center gap-2">
          <i class="bi bi-clock-history"></i>
          Tenemos horas disponibles en:
        </div>
        <div class="d-flex flex-wrap gap-2">
          {% for service in servicios_disponibles %}
            <span class="badge text-light fs-6">{{ service.name }}</span>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {# RESUMEN FINAL ANTES DE CONFIRMAR #}
    {% if step == 'final' %}
      <section class="maple-hero-block text-center my-4">
        <div class="maple-hero-badge text-uppercase">
          <i class="bi bi-shield-check"></i>
          Confirmación
        </div>
        <h1 class="display-5 mt-3">¡Está a punto de reservar su hora!</h1>
        <p class="lead mb-0">Revisa con calma la información antes de confirmar.</p>
      </section>

      {% if servicio_nombre %}
        <div class="maple-card mb-3">
          <h3>Servicio seleccionado</h3>
          <p class="mb-0">{{ servicio_nombre }}</p>
        </div>
      {% endif %}

      <div class="maple-card mb-3">
        <h3>Detalles del Cliente</h3>
        <ul class="mb-0">
          <li><strong>Rut:</strong> {{ cliente.rut }}</li>
          <li><strong>Nombre:</strong> {{ cliente.nombre_cliente }}</li>
          <li><strong>Dirección:</strong> {{ cliente.direccion }}</li>
          <li><strong>Teléfono:</strong> {{ cliente.telefono }}</li>
          <li><strong>Email:</strong> {{ cliente.email }}</li>
        </ul>
      </div>

      <div class="maple-card mb-3">
        <h3>Detalles de la Mascota</h3>
        <ul class="mb-0">
          <li><strong>Nombre:</strong> {{ mascota.nombre }}</li>
          <li><strong>Número de Chip:</strong> {{ mascota.numero_chip }}</li>
        </ul>
      </div>
    {% endif %}

    {# CARD PRINCIPAL DEL FORMULARIO (TODOS LOS PASOS) #}
    <div class="maple-card mb-3">
      {% if step != '' and step != 'final' %}
        <h2 class="h4 mb-3">{{ titulo }}</h2>
      {% endif %}

      {% if servicio_nombre %}
        <div class="maple-info-card mb-3" role="status">
          <strong>Servicio seleccionado:</strong> {{ servicio_nombre }}
        </div>
      {% endif %}

      {% if step == 'crear_cliente' and cliente_rut %}
        <div class="maple-info-card mb-3" role="status">
          <strong>RUT registrado:</strong> {{ cliente_rut }}</strong>
        </div>
      {% endif %}

      <form method="post" class="maple-form" id="booking-form">
        {% csrf_token %}
        {% if step == 'final' %}
          {% if form.non_field_errors %}
            <div class="alert alert-danger" role="alert">
              {{ form.non_field_errors|join:' ' }}
            </div>
          {% endif %}

          <div class="d-none">
            {{ form.n_cita }}
          </div>

          <div class="row g-4 align-items-start">
            <div class="col-lg-8">
              <div class="booking-calendar shadow-sm">
                <div class="calendar-header">
                  <div>
                    <div class="text-uppercase text-muted small fw-semibold">Seleccione una Fecha y Hora:</div>
                    <div class="h5 mb-0" id="current-month-label"></div>
                  </div>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-maple" type="button" id="prev-month-btn" aria-label="Mes anterior">
                      <i class="bi bi-chevron-left"></i>
                    </button>
                    <button class="btn btn-outline-maple" type="button" id="next-month-btn" aria-label="Mes siguiente">
                      <i class="bi bi-chevron-right"></i>
                    </button>
                  </div>
                </div>
                <div class="calendar-grid mb-2" id="calendar-weekdays">
                  <div class="calendar-weekday text-center">L</div>
                  <div class="calendar-weekday text-center">M</div>
                  <div class="calendar-weekday text-center">M</div>
                  <div class="calendar-weekday text-center">J</div>
                  <div class="calendar-weekday text-center">V</div>
                  <div class="calendar-weekday text-center">S</div>
                  <div class="calendar-weekday text-center">D</div>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
              </div>

              <div class="maple-info-card mt-3" id="time-slot-panel">
                <div class="d-flex align-items-center gap-2 mb-2">
                  <span class="rounded-circle bg-warning text-white d-inline-flex justify-content-center align-items-center" style="width: 2.5rem; height: 2.5rem;">
                    <i class="bi bi-clock-history"></i>
                  </span>
                  <div>
                    <div class="text-uppercase text-muted small fw-semibold">Horas disponibles</div>
                    <div class="fw-bold" id="time-slot-title">Selecciona una fecha</div>
                  </div>
                </div>
                <div id="time-slot-list" class="d-flex flex-wrap gap-2"></div>
                <p class="slot-helper mb-0" id="time-slot-helper">Elige un día en el calendario para ver sus horarios disponibles.</p>
              </div>

              {% if form.n_cita.errors %}
                <div class="alert alert-danger mt-3" role="alert">
                  {{ form.n_cita.errors|join:' ' }}
                </div>
              {% endif %}
            </div>

            <div class="col-lg-4">
              <div class="summary-card sticky-lg" id="selection-summary" hidden>
                <div class="d-flex align-items-center gap-3 mb-3">
                  <div id="summary-avatar-wrapper">
                    <img src="" alt="Fotografía del veterinario" class="summary-avatar d-none" id="summary-avatar" />
                    <div class="summary-avatar-fallback" id="summary-avatar-fallback" aria-hidden="true">
                      <i class="bi bi-person-fill"></i>
                    </div>
                  </div>
                  <div>
                    <div class="summary-label mb-1">Profesional</div>
                    <div class="h5 mb-0" id="summary-vet">—</div>
                  </div>
                </div>

                <div class="summary-meta">
                  <div>
                    <div class="summary-label">Fecha seleccionada</div>
                    <div class="summary-value" id="summary-date">—</div>
                  </div>
                  <div>
                    <div class="summary-label">Hora seleccionada</div>
                    <div class="summary-value" id="summary-time">—</div>
                  </div>
                  {% if servicio_nombre %}
                    <div>
                      <div class="summary-label">Servicio</div>
                      <div class="summary-value" id="summary-service">{{ servicio_nombre }}</div>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% else %}
          {{ form.as_p }}
        {% endif %}

        <button type="submit" class="btn btn-maple-green w-100 mb-2">
          {% if step == 'final' %}Confirmar reserva{% else %}Continuar{% endif %}
        </button>
      </form>

      {% if step == '' %}
        <a href="{% url 'ambpublico_cancelar_cita' %}" class="btn btn-maple-red w-100">
          Cancelar cita
        </a>
      {% else %}
        <a href="{% url 'ambpublico_reserva_cancelar' %}" class="btn btn-maple-red w-100">
          Cancelar
        </a>
      {% endif %}

      {% if step == 'crear_mascota' %}
        <script>
          document.addEventListener('DOMContentLoaded', function () {
            const speciesField = document.getElementById('id_especie');
            const breedField = document.getElementById('id_raza');

            if (!speciesField || !breedField) return;

            const breedOptions = {
              'Perro': ['Mestizo', 'Labrador Retriever', 'Pastor Alemán', 'Poodle', 'Bulldog', 'Beagle', 'Golden Retriever', 'Chihuahua', 'Pug', 'Schnauzer'],
              'Gato': ['Mestizo', 'Siamés', 'Persa', 'Maine Coon', 'Bengalí', 'Sphynx', 'British Shorthair', 'Abisinio', 'Angora Turco', 'Ragdoll'],
              'Otros': ['Erizo', 'Hámster', 'Ratón', 'Cobaya', 'Conejo', 'Hurón', 'Tortuga', 'Iguana', 'Ave Exótica', 'Pez']
            };

            const createPlaceholder = () => {
              const option = document.createElement('option');
              option.value = '';
              option.textContent = 'Seleccione una raza';
              option.disabled = true;
              return option;
            };

            const populateBreeds = (species, preserveSelection = false) => {
              const previousValue = preserveSelection ? breedField.value : '';
              const options = breedOptions[species] ? [...breedOptions[species]] : [];
              if (previousValue && !options.includes(previousValue)) options.push(previousValue);

              breedField.innerHTML = '';
              const placeholder = createPlaceholder();
              breedField.appendChild(placeholder);

              options.forEach(breed => {
                const option = document.createElement('option');
                option.value = breed;
                option.textContent = breed;
                breedField.appendChild(option);
              });

              if (previousValue && options.includes(previousValue)) {
                breedField.value = previousValue;
                placeholder.selected = false;
              } else {
                placeholder.selected = true;
              }

              breedField.disabled = options.length === 0;
            };

            speciesField.addEventListener('change', event => populateBreeds(event.target.value, false));
            populateBreeds(speciesField.value, true);
          });
        </script>
      {% endif %}
    </div>  {# cierre maple-card #}

  {% endif %}  {# cierre del else de step != 'nohours' #}

  {% if step == 'final' %}
    {{ available_slots|json_script:"slot-data" }}
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const slotDataElement = document.getElementById('slot-data');
        const slotData = slotDataElement ? JSON.parse(slotDataElement.textContent) : [];

        const slotsByDate = slotData.reduce((acc, slot) => {
          if (!acc[slot.date]) acc[slot.date] = [];
          acc[slot.date].push(slot);
          return acc;
        }, {});

        const availableDates = Object.keys(slotsByDate).sort();
        const selectField = document.getElementById('id_n_cita');
        const calendarGrid = document.getElementById('calendar-grid');
        const monthLabel = document.getElementById('current-month-label');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const timeSlotList = document.getElementById('time-slot-list');
        const timeSlotHelper = document.getElementById('time-slot-helper');
        const timeSlotTitle = document.getElementById('time-slot-title');
        const summaryCard = document.getElementById('selection-summary');
        const summaryVet = document.getElementById('summary-vet');
        const summaryDate = document.getElementById('summary-date');
        const summaryTime = document.getElementById('summary-time');
        const summaryAvatar = document.getElementById('summary-avatar');
        const summaryAvatarFallback = document.getElementById('summary-avatar-fallback');

        if (selectField) {
          selectField.classList.add('d-none');
          selectField.setAttribute('aria-hidden', 'true');
        }

        const findSlotById = (id) => slotData.find((slot) => slot.id === id);

        let selectedSlotId = selectField ? selectField.value : null;
        let selectedDate = null;

        if (selectedSlotId) {
          const selectedSlot = findSlotById(selectedSlotId);
          if (selectedSlot) {
            selectedDate = selectedSlot.date;
          } else {
            selectedSlotId = null;
          }
        }

        const minMonthDate = availableDates.length ? new Date(`${availableDates[0]}T00:00:00`) : new Date();
        const maxMonthDate = availableDates.length ? new Date(`${availableDates[availableDates.length - 1]}T00:00:00`) : new Date();
        const startingMonth = selectedDate || availableDates[0];
        let currentMonth = startingMonth ? new Date(`${startingMonth}T00:00:00`) : new Date();

        const formatMonth = (date) =>
          date.toLocaleDateString('es-CL', {month: 'long', year: 'numeric'}).replace(/^./, (s) => s.toUpperCase());

        const renderCalendar = () => {
          if (!calendarGrid || !monthLabel) return;

          const startOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
          const endOfMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
          const offset = (startOfMonth.getDay() + 6) % 7; // Empezando en lunes

          calendarGrid.innerHTML = '';
          monthLabel.textContent = formatMonth(currentMonth);

          for (let i = 0; i < offset; i += 1) {
            const spacer = document.createElement('div');
            spacer.className = 'calendar-day-btn disabled';
            spacer.setAttribute('aria-hidden', 'true');
            calendarGrid.appendChild(spacer);
          }

          for (let day = 1; day <= endOfMonth.getDate(); day += 1) {
            const dateObj = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), day);
            const dateStr = dateObj.toISOString().slice(0, 10);
            const hasSlots = Boolean(slotsByDate[dateStr]);

            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'calendar-day-btn text-center';
            btn.textContent = day;

            if (hasSlots) {
              btn.classList.add('available');
              btn.addEventListener('click', () => handleDateSelection(dateStr));
            } else {
              btn.classList.add('disabled');
              btn.disabled = true;
              btn.setAttribute('aria-disabled', 'true');
            }

            if (selectedDate === dateStr) {
              btn.classList.add('selected');
            }

            calendarGrid.appendChild(btn);
          }

          if (prevMonthBtn) {
            const prevMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
            prevMonthBtn.disabled = prevMonth < new Date(minMonthDate.getFullYear(), minMonthDate.getMonth(), 1);
          }

          if (nextMonthBtn) {
            const nextMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            nextMonthBtn.disabled = nextMonth > new Date(maxMonthDate.getFullYear(), maxMonthDate.getMonth(), 1);
          }
        };

        const updateSummary = (slot) => {
          if (!summaryCard) return;

          if (!slot) {
            summaryCard.hidden = true;
            return;
          }

          summaryCard.hidden = false;
          summaryVet.textContent = slot.veterinario;
          summaryDate.textContent = slot.date_label;
          summaryTime.textContent = slot.time;

          if (summaryAvatar) {
            if (slot.veterinario_photo) {
              summaryAvatar.src = slot.veterinario_photo;
              summaryAvatar.classList.remove('d-none');
              summaryAvatarFallback.classList.add('d-none');
            } else {
              summaryAvatar.classList.add('d-none');
              summaryAvatarFallback.classList.remove('d-none');
            }
          }
        };

        const selectSlot = (slot) => {
          selectedDate = slot.date;
          selectedSlotId = slot.id;
          if (selectField) {
            selectField.value = slot.id;
          }
          renderTimeSlots(slot.date);
          renderCalendar();
          updateSummary(slot);
        };

        const renderTimeSlots = (dateStr) => {
          if (!timeSlotList) return;

          timeSlotList.innerHTML = '';

          if (!dateStr) {
            timeSlotHelper.textContent = 'Elige un día en el calendario para ver sus horarios disponibles.';
            timeSlotTitle.textContent = 'Selecciona una fecha';
            updateSummary(null);
            return;
          }

          const slots = slotsByDate[dateStr] || [];
          timeSlotTitle.textContent = slots.length ? 'Selecciona un horario' : 'Sin horarios disponibles';
          timeSlotHelper.textContent = slots.length
            ? 'Elige la hora que prefieras para continuar con tu reserva.'
            : 'Esta fecha no cuenta con horarios disponibles.';

          slots.forEach((slot) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'time-slot-btn';
            btn.innerHTML = `<span class="time-label">${slot.time}</span><span class="vet-label">${slot.veterinario}</span>`;

            if (slot.id === selectedSlotId) {
              btn.classList.add('active');
            }

            btn.addEventListener('click', () => selectSlot(slot));
            timeSlotList.appendChild(btn);
          });

          if (slots.length && !selectedSlotId) {
            timeSlotHelper.textContent = 'Recuerda seleccionar una hora para confirmar tu reserva.';
          }
        };

        const handleDateSelection = (dateStr) => {
          selectedDate = dateStr;
          selectedSlotId = null;
          if (selectField) {
            selectField.value = '';
          }
          renderTimeSlots(dateStr);
          renderCalendar();
          updateSummary(null);
        };

        if (prevMonthBtn) {
          prevMonthBtn.addEventListener('click', () => {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1);
            renderCalendar();
          });
        }

        if (nextMonthBtn) {
          nextMonthBtn.addEventListener('click', () => {
            currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1);
            renderCalendar();
          });
        }

        const initialSlot = selectedSlotId ? findSlotById(selectedSlotId) : null;
        if (!selectedDate && availableDates.length) {
          currentMonth = new Date(`${availableDates[0]}T00:00:00`);
        }

        renderCalendar();
        renderTimeSlots(selectedDate);
        if (initialSlot) {
          updateSummary(initialSlot);
          renderTimeSlots(initialSlot.date);
        }
      });
    </script>
  {% endif %}

{% endblock content %}

